import{I as w,V as G,R as q,J as re,L as O,K as oe,U as ie,ad as R,N as a,a0 as ne,aa as le,a1 as ce,ae as de,af as ue,ab as pe,S as m,ac as C,a2 as Ae}from"./index-CYXlB6di.js";import{u as fe}from"./useQuery-hx1aMKYH.js";import{C as me,g as k,c as he,p as I,b as Ee,f as Ne,i as Ie}from"./homeServices-C-QDDkvr.js";import{u as Te,F as xe}from"./useForcedBreak-BFwnm0D4.js";import{a as F,f as M}from"./currency-CxFzcO-j.js";import{b as Se}from"./timesAndDates-BA0J74pm.js";import{u as Q}from"./useLocalStorage-C6Tu5Tk7.js";import{h as B}from"./handleApiError-Mr_6qIMG.js";import{R as Ce}from"./refresh-cw-CufRmD9-.js";import"./apiEndpoints-aSQtSIWE.js";import"./format-BBYAYFtJ.js";import"./startOfDay-Be0wd0F5.js";import"./timer-CktEQguA.js";import"./clock-IyxNcF_P.js";import"./addDays-CyOWDzeI.js";import"./pt-BR-mIVN-mbg.js";const ge=[["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M21 11.75V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7.25",key:"1jrsq6"}],["path",{d:"m22 22-1.875-1.875",key:"13zax7"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 2v4",key:"1cmpym"}],["circle",{cx:"18",cy:"18",r:"3",key:"1xkwt0"}]],Oe=w("calendar-search",ge);const Re=[["path",{d:"M12 16h.01",key:"1drbdi"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M15.312 2a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586l-4.688-4.688A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2z",key:"1fd625"}]],be=w("octagon-alert",Re);const Le=[["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m14.305 16.53.923-.382",key:"1itpsq"}],["path",{d:"m15.228 13.852-.923-.383",key:"eplpkm"}],["path",{d:"m16.852 12.228-.383-.923",key:"13v3q0"}],["path",{d:"m16.852 17.772-.383.924",key:"1i8mnm"}],["path",{d:"m19.148 12.228.383-.923",key:"1q8j1v"}],["path",{d:"m19.53 18.696-.382-.924",key:"vk1qj3"}],["path",{d:"m20.772 13.852.924-.383",key:"n880s0"}],["path",{d:"m20.772 16.148.924.383",key:"1g6xey"}],["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],_e=w("user-cog",Le);async function ye(T,i){try{const E=G();if(!E)return[];const{empresaId:_,codigoUsuario:y}=E,b=await q.get(`v2/trade/pdv/events/${_}/${y}`,{params:{CLI_CODIGO:T,GEV_CLI_ID:i},timeout:3e3}),{data:x}=b.data;if(x)return x}catch(E){return B(E,[])}}function Ve(){const T=re(),[i,E]=O.useState(null),[,_,y]=Q("currentSearch"),[b,x]=Q("currentCustomer"),[S,H]=O.useState(null),[o,g]=O.useState(null),[z,$]=O.useState(!1),{showLoading:D,hideLoading:L}=oe(),{stopWatch:V,interruptForced:W,isBlocked:v}=Te(i),{data:P,isFetching:K,isLoading:J}=fe({queryKey:["events"],queryFn:()=>ye(o.CLI_CODIGO,o.CLI_ID),enabled:!!o});function Y(e){if(v){m("Não é possível iniciar pesquisas durante a pausa obrigatória",2);return}const s=S.findIndex(d=>d.GFP_ID===e.GFP_ID);_({todasPesquisas:S,pesquisa:e,cliente:o,posSearch:s}),e.DETALHAMENTO[0].PERGUNTAS?T("/single-question"):T("/group-question")}async function X(){if(v){m("Não é possível ir para a administração durante a pausa obrigatória",2);return}i&&!i.CONFERENCE&&!i.ORDERS&&(i.CONFERENCE={INVENTORY:[],PRODUCTS:[],lastAddPos:null,finishConference:null,orderAdmin:[],open:!0},i.ORDERS={ADD:[],INPROGRESS:[],NEW:[]},i.ORDERS_DIRECT={ADD:[],INPROGRESS:[],NEW:[]},await C(i)),T("/Admin")}async function Z(){try{if(v){m("Não é possível fazer check-out durante a pausa obrigatória",2);return}if(!await Ae({title:"Check-out",message:"Confirmar operação de check-out? está encerrando o atendimento nesse cliente"}))return;if(S.filter(t=>t.ALERTA_OBRIGATORIO===!1).length!==S.length){m("Ainda existem pesquisas obrigatórias não respondidas");return}D();const d=i?.HORARIOS_TRABALHO?.RAIO_ATENDIMENTO>=0;let r=o;if(d&&!o.checkoutLiberado){const{latitude:t,longitude:p,error:u}=await k();if(!t||!p){m(u||"Não foi possível buscar a localização atual, tente novamente");return}const A=await he(o,i,t,p,!0);if(r=I(o,n=>{if(!A)n.alert=[{descricao:null,liberado:!0,lido:null}],n.checkoutLiberado=!0;else{const f=A.map(c=>({descricao:c.GTI_DESCRICAO,galId:c.GAL_ID,liberado:c.GTI_FLG_IMPEDE_ATD!==1,lido:c.GAL_FLG_STATUS===1,DISTANCE:c.DISTANCE,distanceNumber:c.distanceNumber}));n.alert=f,n.galId=f.find(c=>c.liberado===!1)?.galId,n.checkoutLiberado=!1}}),g(r),x(r),!r.checkoutLiberado){m("Fora do raio de atendimento",2);const n=I(i,f=>{const c=f.CLIENTES?.findIndex(N=>N.SEQ_PADRAO===r.SEQ_PADRAO||N.SEQ_PADRAO===f.cliAtendimento);c!==-1&&(f.CLIENTES[c]=r)});await C(n);return}}if(!await Ee(i,!1,D,!0)){m(`Não foi possível fazer o Check-out.
Verifique sua conexão com a internet e se seu GPS está ativo`);return}await ae(!0),T("/customer-service")}catch(e){B(e,!1)}finally{L()}}async function ee(){try{D();const e=i.CLIENTES.findIndex(t=>t.SEQ_PADRAO===o.SEQ_PADRAO),s=i.CLIENTES[e]?.alert?.findIndex(t=>t.liberado===!1),{latitude:d,longitude:r}=await k();if(o.CLI_LATITUDE!==null&&o.CLI_LONGITUDE!==null&&o.status!==1&&o.galId!==!1&&d&&r){let t=await Ne(o.CLI_LATITUDE,o.CLI_LONGITUDE,d,r,"K");t=t*1e3;const p=i.HORARIOS_TRABALHO.RAIO_ATENDIMENTO,u=t>1e3?`${parseFloat(M(t/1e3))}km`:`${parseFloat(M(t))}m`;if(t<=p){const A={pos:e,status:1};await te(i?.CLIENTES[e]?.alert[s]?.galId),await j(A),m("Atendimento liberado",1),L();return}else typeof e=="number"&&e!==-1&&typeof s=="number"&&s!==-1&&(i.CLIENTES[e].alert[s].DISTANCE=u,await C(i))}const l=await Ie(o,i,1);await j(l)}catch{}finally{L()}}async function te(e){try{const s=G();if(s){const d=s.empresaId,r=s.codigoUsuario,l={};l.galId=e,l.liberado=!0,l.lido=!0,await q.put(`v1/tradedashboard/alerts/${d}/${r}`,l)}}catch{}}async function j(e){if(!e)return;if(e.pos===void 0||!i.CLIENTES[e.pos]){console.error("Invalid customer position in handleStopBlock");return}const s=i.CLIENTES[e.pos].alert?.findIndex(r=>r.liberado===!1);if(s===-1||s===void 0){m("Atendimento liberado",1);const r=I(o,l=>{l.alert=[],l.galId=!1,l.checkoutLiberado=!0});g(r),x(r);return}const d=Se(new Date);if(e.status===1){const r=I(i,t=>{t.CLIENTES[e.pos].alert[s].liberado=!0,t.CLIENTES[e.pos].alert[s].lido=!0,t.CLIENTES[e.pos].alert[s].observation=`Liberado ${d}`,t.CLIENTES[e.pos].galId=!1,t.CLIENTES[e.pos].checkoutLiberado=!0}),l=I(o,t=>{t.alert=[],t.galId=!1,t.checkoutLiberado=!0});E(r),g(l),x(l),m("Atendimento liberado",1),await C(r)}else if(e.status===-1){const r=I(i,t=>{t.CLIENTES[e.pos].alert[s].liberado=-1,t.CLIENTES[e.pos].alert[s].lido=!0,t.CLIENTES[e.pos].alert[s].observation=`Não foi liberado ${d}`,t.CLIENTES[e.pos].galId=-1}),l=I(o,t=>{t.alert=[]});E(r),g(l),x(l),await C(r)}}async function ae(e=!1){const{latitude:s,longitude:d,error:r}=await k();if(!s||!d){m(r||"Não foi possível buscar a localização atual, tente novamente"),L();return}const l=I(i,function(t){for(const p of t.CLIENTES)if(p.SEQ_PADRAO===o?.SEQ_PADRAO){if(e){for(const u of p.checkIn)if(u.status===1){u.status=0,u.stop=new Date,u.latitudeCheckOut=s,u.longitudeCheckOut=d;break}p.status=2,p.lastCheckout=new Date,t.emAtendimento=!1,t.cliAtendimento=o?.SEQ_PADRAO}else p.pesquisas=S;break}t.cliAtendimento=void 0});await C(l)}return O.useEffect(()=>{(async function(){try{y();let s=null;b&&(s=b);const d=await ie(),r=d?.CLIENTES?.findIndex(t=>t.SEQ_PADRAO===s?.SEQ_PADRAO||t.SEQ_PADRAO===d?.cliAtendimento);if(r!==-1){g(d?.CLIENTES[r]);const t=d?.CLIENTES[r].pesquisas;let p=!1,u=0,A=0;for(const n of t){if(p=!1,u=0,A=0,n.DETALHAMENTO[0]!==void 0&&n.DETALHAMENTO[0].PERGUNTAS!==void 0){const f=n.DETALHAMENTO[0].PERGUNTAS.filter(c=>c.GPP_FLG_STATUS===1);u+=f.length,A+=f.filter(c=>R(c.RESPOSTA))?.length,n.ALERTA_OBRIGATORIO=n.DETALHAMENTO[0]?.GAP_FLG_OBRIGATORIA_NAO_APLICA?!1:f.find(c=>c.GPP_FLG_ORIGATORIA===1&&!R(c.RESPOSTA))!==void 0,n.QTDE_PERGUNTAS=u,n.QTDE_PERGUNTAS_RESPONDIDAS=A,n.PERCENTUAL_CONCLUIDO=F(100*A/u,0)+"%",n.CONCLUIDO=100*A/u;continue}if(n.DETALHAMENTO[0]!==void 0&&n.DETALHAMENTO[0].AGRUPAMENTO!==void 0){for(const f of n.DETALHAMENTO[0].AGRUPAMENTO){for(const c of f.ITEMS){const N=c.PERGUNTAS.filter(h=>h.GPP_FLG_STATUS===1);u+=N.length;const U=N.filter(h=>R(h.RESPOSTA)),se=N.every(h=>h.GPP_FLG_ORIGATORIA===0&&c.GGI_FLG_ORIGATORIA_NAO_APLICA===1);A+=se?N.filter(h=>R(h.RESPOSTA)).length:U?U.length:0,p||(p=N.find(h=>h.GPP_FLG_ORIGATORIA===1&&!R(h.RESPOSTA)&&c.GGI_FLG_ORIGATORIA_NAO_APLICA===0)!==void 0)}n.QTDE_PERGUNTAS=u,n.QTDE_PERGUNTAS_RESPONDIDAS=A,n.PERCENTUAL_CONCLUIDO=F(100*A/u,0)+"%",n.CONCLUIDO=100*A/u}n.ALERTA_OBRIGATORIO=n.DETALHAMENTO[0]?.GAP_FLG_OBRIGATORIA_NAO_APLICA?!1:p}}H(t)}E(d);const l=G();l&&$(l?.flagAdministrativo)}catch{}})()},[]),K||J?a.jsx(ne,{loadingTrue:!0}):a.jsxs(a.Fragment,{children:[a.jsx(le,{title:"Pesquisas",showBackButton:!0,backPath:"/customer-service"}),a.jsxs("div",{className:"min-h-full background-pages flex flex-col pt-2 lg:pt-14",children:[a.jsxs("section",{className:"items-start justify-between p-2 flex flex-col gap-2",children:[a.jsx("h2",{className:"text-4xl font-bold text-center text-primary w-full",children:o?.CLI_NOME_FANTASIA}),z&&a.jsxs("button",{onClick:X,className:"px-4 py-2 bg-primary/90 text-white rounded-full text-lg flex items-center gap-2 active:scale-95 transition-transform drop-shadow-xl drop-shadow-primary/40",children:[a.jsx("i",{children:a.jsx(_e,{size:22})}),"Admin"]}),P&&P?.length>0&&a.jsxs("button",{onClick:()=>T("/events",{state:P}),className:"px-4 py-2 bg-primary/90 text-white rounded-full text-lg flex items-center gap-2 active:scale-95 transition-transform drop-shadow-xl drop-shadow-primary/40",children:[a.jsx("i",{children:a.jsx(Oe,{size:22})}),"Ver os eventos para esse cliente"]}),Array.isArray(o?.alert)&&o?.alert?.find(e=>e.liberado===!1)&&a.jsxs("div",{className:"w-full flex flex-col items-center justify-center gap-2 bg-red-50 border border-red-200/80 rounded-lg p-3",children:[a.jsxs("span",{className:"text-center font-semibold text-red-800 text-base",children:["Check-out bloqueado - Distância:"," ",o?.alert?.find(e=>e.liberado===!1)?.DISTANCE]}),a.jsxs("button",{onClick:ee,className:"px-4 py-2 bg-primary/90 text-white rounded-full text-sm flex items-center gap-2 active:scale-95 transition-transform",children:[a.jsx("i",{children:a.jsx(Ce,{size:16})}),"Verificar liberação"]})]})]}),a.jsxs("main",{className:"flex-1 overflow-y-auto px-1 pb-24 pt-4",children:[a.jsx(xe,{stopWatch:V,interruptForced:W}),a.jsx("div",{className:"w-full space-y-4",children:S?.map(e=>{const s=e.QTDE_PERGUNTAS_RESPONDIDAS/e.QTDE_PERGUNTAS*100;return a.jsx("div",{className:ce("rounded-2xl p-px shadow-sm",e.ALERTA_OBRIGATORIO?"bg-linear-to-r from-red-100 via-orange-200 to-red-700":"bg-linear-to-r from-green-100 via-emerald-200 to-green-700"),children:a.jsx("button",{onClick:()=>Y(e),className:"relative w-full bg-white rounded-[calc(1rem-1px)] overflow-hidden",children:a.jsxs("div",{className:"py-4 px-2",children:[a.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-full bg-linear-to-br from-primary/65 to-primary flex items-center justify-center shadow-lg shrink-0",children:a.jsx(me,{size:24,className:"text-white"})}),a.jsxs("div",{className:"flex-1 text-left",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.GAP_ICONE&&a.jsx("img",{src:e.GAP_ICONE,alt:e.GAP_DESCRICAO,className:"h-6 w-6"}),a.jsx("h2",{className:"text-gray-900 font-semibold",children:e.GAP_DESCRICAO}),e.ALERTA_OBRIGATORIO?a.jsx(be,{size:18,strokeWidth:3,className:"text-red-500 shrink-0"}):a.jsx(de,{size:18,strokeWidth:3,className:"text-primary shrink-0"})]}),a.jsxs("p",{className:"text-sm text-gray-600",children:[e.QTDE_PERGUNTAS_RESPONDIDAS,"/",e.QTDE_PERGUNTAS," respondidas"]})]}),a.jsx(ue,{size:24,className:"text-gray-400"})]}),a.jsx("div",{className:"relative w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:a.jsx("div",{className:"absolute top-0 left-0 h-full bg-linear-to-r from-primary/35 to-primary transition-all duration-300 rounded-full",style:{width:`${s}%`}})})]})})},e.GFP_ID)})})]}),a.jsx("footer",{className:"fixed bottom-0 left-0 right-0 bg-white/50 backdrop-blur-sm border-t border-primary/20 p-4 shrink-0",children:a.jsx("div",{className:"w-full",children:a.jsxs("button",{onClick:()=>{if(Array.isArray(o?.alert)&&o?.alert?.find(e=>e.liberado===!1)){m("Check-out bloqueado",2);return}Z()},className:"drop-shadow-xl lg:ml-20 drop-shadow-primary/40 w-full max-w-[220px] py-3 px-6 rounded-2xl bg-primary/90 text-white active:scale-[0.98] transition-transform flex items-center justify-center gap-2 font-semibold",children:[a.jsx(pe,{size:20}),a.jsx("span",{className:"text-base",children:"Check-out"})]})})})]})]})}export{Ve as default};
