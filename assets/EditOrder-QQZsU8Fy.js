import{L as u,K as la,ap as ia,J as Ea,N as s,aa as ca,O as m,ae as _a,U as T,ac as h,S as N,V as da,R as F}from"./index-DyoTrttr.js";import{u as U}from"./index.esm-C9r6uydG.js";import{C as Pa,b as Ia,c as Oa,a as ua}from"./card-CZfL1EZR.js";import{F as G,a as Q,b as z,c as B,d as k}from"./form-9mnPmkj3.js";import{I as Ra,T as fa}from"./textarea-6_FaalO1.js";import{F as v,a as l,b as xa}from"./currency-CxFzcO-j.js";import{c as H,e as $}from"./order-Cfswk0WD.js";import{P as ma}from"./pencil-BE7HBbnh.js";import{T as Ta}from"./trash-2-CBtipvfx.js";import{S as ha}from"./save-CfZQJkP1.js";import"./label-CxnlyZpL.js";import"./input-UCdoJ7gY.js";import"./apiEndpoints-aSQtSIWE.js";import"./handleApiError-kT6tIuMW.js";import"./format-BBYAYFtJ.js";import"./startOfDay-Be0wd0F5.js";function Ga(){const[o,R]=u.useState([]),[L,q]=u.useState([]),[f,w]=u.useState(!1),[J,K]=u.useState(null),S=U(),{getValues:W}=S,p=U(),{handleSubmit:X,setValue:x,setFocus:Y}=p,{hideLoading:d,showLoading:A}=la(),V=ia(),M=Ea(),C=V.state?.view,j=V.state?.id;async function Z(r,t){const a=o[t].ITEMS.filter(D=>D.PED_NR_PEDIDO!==r.PED_NR_PEDIDO),i=[...L];!a.find(D=>D.PED_NR_PEDIDO===r.PED_NR_PEDIDO)&&r.PED_NR_PEDIDO!==-1&&i.push(r.PED_NR_PEDIDO),o[t].ITEMS=a,R(o),q(i)}async function aa(r){const t=await T();let a=o[0];if(await Promise.all(L.map(async e=>await H(e,!1))),!a){await H(a[0].ATD_ID),t.ORDERS_DIRECT.INPROGRESS=o.filter(e=>e.ATD_ID!==a[0].ATD_ID),await h(t),M("/Admin/HistoricOrders");return}if(t.ORDERS_DIRECT.INPROGRESS=o,await h(t),A(),!a.ITEMS?.every(e=>l(e.PED_VALOR_UNIT))){N("Informe os valores"),d();return}const _=a.ITEMS.filter(e=>J?.GPA_OPER_ID_CONSIGNACAO_DEV===e.PED_OPER_ID&&e.UPDATE);if(_&&_.length>0&&(a=await sa(_)),!a){d();return}const D=a.ITEMS?.map(e=>(e.PED_VALOR_UNIT=l(e.PED_VALOR_UNIT),{PED_OPER_ID:a.ATD_OPER_ID,PED_PROD_ID:e.PROD_ID_VENDA||e.PED_PROD_ID||e.PROD_ID,PED_QTDE:e.PED_QTDE,PED_VALOR_UNIT:l(e.PED_VALOR_UNIT),PED_VALOR:l(e.PED_VALOR_UNIT)*e.PED_QTDE,PED_ESIN_EMP_ID:e.PED_ESIN_EMP_ID_VENDA||e.PED_ESIN_EMP_ID||a.ATD_EMP_ID,PED_ESIN_ID:e.ESIN_ID_VENDA||e.PED_ESIN_ID,PED_NR_PEDIDO:e.PED_NR_PEDIDO||e.PED_ID,PED_OBS:e.PED_OBS,PROD_DESCR:e.PROD_DESCR,PRODUTO:e.PRODUTO})),g=D.reduce((e,E)=>l(e)+l(E.PED_VALOR),0),y=D.reduce((e,E)=>l(e)+l(E.PED_QTDE),0),b=W("ATD_OBS"),P=await $(a.ATD_TIPO_FRETE,a.ATD_OPER_ID,a.ATD_EMP_ID,a.ATD_ID,a.ATD_CLI_ID,t.ESTR_ID,g,b,y,D,[]);P&&P.length>0&&(o[r]=P[0],t.ORDERS_DIRECT.INPROGRESS=o,await h(t)),d(),M("/Admin/HistoricOrders")}async function sa(r){try{const t=da();if(t){const a=t.empresaId,i=t.codigoUsuario,_=await T();return await Promise.all(r.map(async(D,g)=>{if(_.OPER_ID_CONSIGNACAO_DEV===D.PED_OPER_ID&&D.UPDATE){const y={ped_id:D.PED_NR_PEDIDO},b=await F.get(`v1/approvalofsales/sales/${a}/${i}`,{params:y}),{sucess:P,data:e}=b.data;if(P&&e&&e.length>0){const E=e[0],I=E.ITEMS.findIndex(c=>c.PED_NR_PEDIDO===D.PED_NR_PEDIDO);I!==-1&&(E.ITEMS[I].PED_VALOR=D.PED_VALOR,E.ITEMS[I].PED_VALOR_UNIT=l(D.PED_VALOR_UNIT),E.ITEMS[I].PED_NR_PEDIDO=D.PED_NR_PEDIDO,E.ITEMS[I].PED_OPER_ID=D.PED_OPER_ID);const oa=E.ITEMS.reduce((c,n)=>l(c)+l(n.PED_VALOR),0),na=E.ITEMS.reduce((c,n)=>l(c)+l(n.PED_QTDE),0),O=await $(e[0].ATD_TIPO_FRETE,e[0].ATD_OPER_ID,e[0].ATD_ID,e[0].ATD_EMP_ID,e[0].ATD_CLI_ID,e[0].ATD_ESTR_ID,oa,e[0].ATD_OBS,na,e[0].ITEMS,e[0].PAGAMENTOS);if(O&&O.length>0){O[0].ITEMS=O[0].ITEMS.map(n=>(n?.PED_NR_PEDIDO===D.PED_NR_PEDIDO&&(n.PED_ESIN_ID=D.PED_ESIN_ID,n.PED_ESIN_EMP_ID=D.PED_ESIN_EMP_ID_VENDA||D.PED_ESIN_EMP_ID||o[g].ATD_EMP_ID,n.PED_PROD_ID=D.PED_PROD_ID,n.PED_OPER_ID=D.PED_OPER_ID),delete n.PED_ID,n.PED_NR_PEDIDO=n.PED_ID,n));let c;c=o.filter(n=>n.PED_NR_PEDIDO!==D.PED_NR_PEDIDO),c=[...o,...O[0].ITEMS],R(c)}}}})),o}}catch(t){console.log(t)}}async function ea({valueOrder:r,indexCompany:t}){try{const a=await T(),i=await ta(r,t);if(!i)return;await h(a),x("valueOrder",""),x("indexCompany",!1),w(!1),R(i)}catch{N("Erro ao atualizar o valor")}}async function ta(r,t){try{if(typeof t!="number"||f==null){N("Erro ao atualizar o valor");return}const a=o[t]?.ITEMS[f];if(!a){N("Erro ao atualizar o valor");return}const i=l(xa(`${r}`));return a.VALOR=i,a.PED_VALOR=i*(a.QTDE_PEDIDO||a.QTDE_LIDO||a.QTDE_ORDER),o}catch(a){console.log(a)}}async function ra(){try{A();const r=await T();let t=r.ORDERS_DIRECT;t&&(t=r.ORDERS_DIRECT.INPROGRESS),t=t.filter(a=>a.ATD_ID===Number(j)),R(t)}catch{}finally{d()}}async function Da(){try{A();const r=await F.get("v1/params"),{sucess:t,data:a}=r.data;t&&K(a)}catch{}finally{d()}}return u.useEffect(()=>{j&&(ra(),Da())},[j]),s.jsxs(s.Fragment,{children:[s.jsx(ca,{title:"Alterar pedido",backPath:"/Admin/HistoricOrders",showBackButton:!0}),s.jsx("div",{className:"flex w-full flex-col gap-4 p-2 pb-20 lg:pt-18",children:s.jsxs("div",{className:"flex w-full flex-col gap-4",children:[o?.map((r,t)=>s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsx("div",{className:"border-b border-gray-200 pb-2",children:s.jsx("span",{className:"text-lg font-bold text-gray-900",children:r.name})}),r.ITEMS.map((a,i)=>s.jsxs(Pa,{className:"border-primary/50 shadow-sm p-0 gap-0",children:[s.jsx(Ia,{className:"bg-primary flex items-center justify-start px-3 py-2 rounded-t-lg",children:s.jsxs(Oa,{className:"text-lg flex items-center justify-start gap-2 font-bold text-white",children:[s.jsx("span",{className:"bg-white rounded-full text-sm px-3 text-primary",children:a.CODIGO_INTEGRACAOO||a.CODIGO||a.PROD_CODIGO}),s.jsx("span",{className:"text-lg",children:a.PRODUTO||a.PROD_DESCR})]})}),s.jsxs(ua,{className:"flex flex-col gap-1 p-2",children:[s.jsxs("div",{className:"flex flex-col gap-1 text-sm text-gray-700",children:[s.jsxs("p",{children:[s.jsx("strong",{children:"Endereço: "}),a.ENDERECO," - ",a.CIDADE," - ",a.UF]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("p",{children:[s.jsx("strong",{children:"Lote: "})," ",a.LOTE]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Série: "})," ",a.SERIE]})]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Qtde: "})," ",a.QTDE_PEDIDO||a.QTDE_LIDO]})]}),s.jsxs("div",{className:"flex items-center justify-start gap-2 border-gray-100",children:[s.jsxs("p",{className:"text-sm",children:[s.jsx("strong",{children:"Valor unitário: "})," ",v(l(a.VALOR))]}),!C&&s.jsx(m,{onClick:()=>{x("valueOrder",v(a.VALOR,!1)),x("indexCompany",t),Y("valueOrder"),w(i)},variant:"ghost",size:"icon",className:"size-7 rounded-full bg-primary hover:bg-primary/95",children:s.jsx(ma,{size:16,className:"text-white"})})]}),typeof f=="number"&&f===i&&s.jsx(G,{...p,children:s.jsxs("form",{className:"flex flex-col gap-2",onSubmit:X(ea),children:[s.jsx(Q,{control:p.control,name:"valueOrder",render:({field:_})=>s.jsxs(z,{children:[s.jsx(B,{children:"Informe o valor unitário"}),s.jsx(k,{children:s.jsx(Ra,{..._,autoFocus:!0})})]})}),s.jsxs(m,{type:"submit",className:"w-full gap-2",children:[s.jsx(_a,{size:20}),"Confirmar"]})]})}),a.PED_VALOR&&s.jsxs("div",{className:"flex items-center justify-between gap-2 border-t border-primary/50 mt-2",children:[s.jsx("span",{className:"text-base font-bold text-gray-900",children:"Valor total"}),s.jsx("span",{className:"text-base font-bold text-primary",children:v(a.PED_VALOR)})]}),s.jsxs(m,{variant:"destructive",className:"mt-2 w-full gap-2",onClick:()=>Z(a,t),children:[s.jsx(Ta,{size:18})," Remover produto"]})]})]},`${a.PROD_ID}_${a.SERIE}`))]},r.name)),s.jsx(G,{...S,children:s.jsx("form",{className:"mt-2 w-full",children:s.jsx(Q,{control:S.control,name:"ATD_OBS",render:({field:r})=>s.jsxs(z,{children:[s.jsx(B,{children:"Observação do pedido"}),s.jsx(k,{children:s.jsx(fa,{...r,maxLength:300,rows:4})})]})})})})]})}),s.jsx("footer",{className:"fixed bottom-0 left-0 right-0 z-50 flex items-center justify-end w-full border-t bg-primary p-4",children:s.jsxs(m,{variant:"default",className:"text-primary bg-white min-w-32",onClick:aa,disabled:!o||o&&o.length===0||C,children:["Salvar",s.jsx(ha,{size:20})]})})]})}export{Ga as default};
