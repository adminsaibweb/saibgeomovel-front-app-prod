import{L as V,K as Y,ap as ss,J as as,N as s,aa as rs,O as j,ae as _s,U as g,S as c,ac as m,V as es}from"./index-DyoTrttr.js";import{u as w}from"./index.esm-C9r6uydG.js";import{C as Es,b as os,c as Ds,a as ts}from"./card-CZfL1EZR.js";import{F as G,a as F,b as B,c as $,d as U}from"./form-9mnPmkj3.js";import{I as ls,T as ns}from"./textarea-6_FaalO1.js";import{F as z,a as t}from"./currency-CxFzcO-j.js";import{d as k}from"./order-Cfswk0WD.js";import{P as Is}from"./pencil-BE7HBbnh.js";import{S as cs}from"./send-b_1PF3ud.js";import"./label-CxnlyZpL.js";import"./input-UCdoJ7gY.js";import"./apiEndpoints-aSQtSIWE.js";import"./handleApiError-kT6tIuMW.js";import"./format-BBYAYFtJ.js";import"./startOfDay-Be0wd0F5.js";function Cs(){const[n,h]=V.useState([]),[b,y]=V.useState(!1),v=w(),L=w(),{handleSubmit:J,setValue:f,setFocus:q}=L,{showLoading:M,hideLoading:i}=Y(),N=ss(),H=as(),x=N.state.statusVenda?JSON.parse(`${N.state.statusVenda}`):null,T=N.state.view,Q=N.state.conference;async function K(E){try{const D=await g(),{indexCompany:e,prod:_,index:l}=E;if(typeof e!="number"){c("Erro ao atualizar o valor sdasdas");return}const O=`valor${b}`,u=E[O];n[e].products[l].VALOR=u,n[e].products[l].PED_VALOR=t(u)*(_.QTDE_PEDIDO||_.QTDE_LIDO||_.QTDE_ORDER),await m(D),f(O,""),f("indexCompany",!1),y(!1),h(n)}catch{c("Erro ao atualizar o valor")}}async function Z(){const E=await g();if(M(),!E.ESTR_ID){c("Esse promotor não possui estrutura comercial"),i();return}if(!E.GPA_GEN_ID_TAB_PRECO){c("Não existe uma tabela de preços definida"),i();return}let D=E?.OPER_ID_VENDA_CONSIGNACAO;if(x===1?D=E?.OPER_ID:x===2?D=E?.OPER_ID_BONIFICACAO:x===3&&(D=E?.OPER_ID_CONSIGNACAO),!D){c("Não existe operação para o tipo de venda selecionado"),i();return}if(!E.OPER_ID_CONSIGNACAO_DEV){c("Não existe operação de devolução"),i();return}const e=await Promise.all(n.map(async o=>{const S=o.products.map(I=>I.ESIN_NOTA_FISCAL);let d=`${o.OBSERVATION||""}; `;return Array.isArray(S)&&S.some(I=>I!=null&&I!=="")&&(d=`NF: ${S} - ${d}`),d}));let _=[];if(n.forEach((o,S)=>{const d=o.products.map(I=>(I.OBSERVATION=o.OBSERVATION,I.SEQUENCIA=S,I));_=[..._,...d]}),!_.every(o=>t(o.PED_VALOR))){c("Informe os valores"),i();return}const O=e.join(" ");let u=await Promise.all(n.map(async(o,S)=>{if(o.id!==-1){if(!E.OPER_ID_CONSIGNACAO_DEV){c("Não existe operação de devolução"),i();return}if(!E.GPA_GEN_ID_TAB_PRECO_DEV){c("Não existe uma tabela de preços definida"),i();return}const d=o.products.map(r=>(r.PED_VALOR_UNIT=t(r.VALOR),r.ESIN_EMP_ID=o.emp,r.ESLO_ID&&r.ESLO_ID!==-1?(r.PED_ESIN_EMP_ID=null,r.PED_ESIN_ID=null,r.PED_ESLO_ID=r.ESLO_ID,r.PED_ESLO_EMP_ID=r.ESLO_EMP_ID):(r.PED_ESIN_ID=r.ESIN_ID,r.PED_ESIN_EMP_ID=r.ESIN_EMP_ID,r.PED_ESLO_ID=null,r.PED_ESLO_EMP_ID=null),r.ESLO_ID=null,r.ESLO_EMP_ID=null,{PED_ADMIN_PERC_VALOR:0,PED_OPER_ID:E.OPER_ID_CONSIGNACAO_DEV,PED_PROD_ID:r.PROD_ID,PED_QTDE:r.QTDE_PEDIDO||r.QTDE_LIDO||r.QTDE_ORDER,PED_VALOR_UNIT:t(r.VALOR),PED_VALOR:t(r.VALOR)*r.QTDE_PEDIDO||r.QTDE_LIDO||r.QTDE_ORDER,PED_GEN_ID_TAB_PRECO:E.GPA_GEN_ID_TAB_PRECO_DEV,ESIN_ID:null,ESIN_EMP_ID_VENDA:r.ESIN_EMP_ID_VENDA??null,PROD_ID_VENDA:r.PROD_ID_VENDA??null,ESIN_ID_VENDA:r.ESIN_ID_VENDA??null,ESIN_CLI_ID_VENDA:r.ESIN_CLI_ID_VENDA??E.CLI_IN_PROGRESS,...r})),I=o.products.map(r=>r.ESIN_NOTA_FISCAL),A=d.reduce((r,C)=>t(r)+t(C.PED_VALOR),0),a=d.reduce((r,C)=>t(r)+t(C.PED_QTDE),0),R=`NF: ${I} - ${o.OBSERVATION||""}; `,p=E.OPER_ID_CONSIGNACAO_DEV,P=await k(null,p,o.id,E.ESTR_ID,A,R,a,d,[]);if(P&&P.length>0)return P[0].SEQUENCIA=S,P[0].ITEMS=P[0].ITEMS.map(r=>(r.PED_OBS=P[0].ATD_ID,r)),await m(E),P[0]}else return o}));u=u.filter(Boolean),u&&u.length>0&&(await W(_,O,u),H("/Admin")),i()}async function W(E,D,e){const _=await g();let l=_?.OPER_ID_VENDA_CONSIGNACAO;x===1?l=_?.OPER_ID:x===2?l=_?.OPER_ID_BONIFICACAO:x===3&&(l=_?.OPER_ID_CONSIGNACAO);let O=_.CLI_IN_PROGRESS;if(!O&&(O=_?.CLIENTES?.find(a=>a.SEQ_PADRAO===_.cliAtendimento)?.CLI_ID,!O&&(O=_?.CLIENTES?.find(a=>a.CLI_ID===_.cliAtendimento)?.CLI_ID,!O))){c("Não foi possível encontrar o cliente atual"),i();return}const u=es(),o=E.map(a=>(a.PED_OPER_ID=l,e.forEach(R=>{const p=R?.ITEMS?.find(P=>P.PED_PROD_ID===a.PROD_ID&&P.PED_ESIN_ID===a.PED_ESIN_ID);p&&(a.PED_NR_PEDIDO=p.PED_ID,a.PED_OBS=p.PED_OBS)}),a.ESIN_EMP_ID=u?.empresaId,a.ESLO_ID&&a.ESLO_ID!==-1?(a.PED_ESIN_EMP_ID=null,a.PED_ESIN_ID=null,a.PED_ESLO_ID=a.ESLO_ID,a.PED_ESLO_EMP_ID=a.ESLO_EMP_ID):(a.PED_ESIN_ID=a.ESIN_ID,a.PED_ESIN_EMP_ID=a.ESIN_EMP_ID,a.PED_ESLO_ID=null,a.PED_ESLO_EMP_ID=null),a.ESLO_ID=null,a.ESLO_EMP_ID=null,{PED_ADMIN_PERC_VALOR:0,PED_PROD_ID:a?.PROD_ID_VENDA||a.PROD_ID,PED_QTDE:a.QTDE_ORDER||a.QTDE_PEDIDO||a.QTDE_LIDO,PED_VALOR_UNIT:t(a.VALOR),PED_VALOR:t(a.VALOR)*(a.QTDE_ORDER||a.QTDE_PEDIDO||a.QTDE_LIDO),SEQUENCIA:a.SEQUENCIA,PED_GEN_ID_TAB_PRECO:_.GPA_GEN_ID_TAB_PRECO,ESIN_ID:null,ESIN_EMP_ID_VENDA:a.ESIN_EMP_ID_VENDA??null,PROD_ID_VENDA:a.PROD_ID_VENDA??null,ESIN_ID_VENDA:a.ESIN_ID_VENDA??null,ESIN_CLI_ID_VENDA:a.ESIN_CLI_ID_VENDA??_.CLI_IN_PROGRESS,...a})),S=o.reduce((a,R)=>t(a)+t(R.PED_VALOR),0),d=o.reduce((a,R)=>t(a)+t(R.PED_QTDE),0),A=await k(null,l,O,_.ESTR_ID,S,D,d,o,[]);return i(),A&&A.length>0?(A[0].ITEMS=o,_.ORDERS_DIRECT.INPROGRESS=[..._.ORDERS_DIRECT.INPROGRESS||[],A[0]],c("Pedido feito com sucesso!",1),await m(_),A[0]):(c("Não foi possível criar o pedido"),{resMain:null,resProducts:[]})}async function X(){try{M();const E=N.state.companys?JSON.parse(`${N.state.companys}`):null;h(E)}catch{}finally{i()}}return V.useEffect(()=>{N.state.companys&&X()},[N.state.companys]),s.jsxs(s.Fragment,{children:[s.jsx(rs,{title:"Novo pedido",backPath:Q==="true"?"/Admin/Conference":"/Admin/OrderDirect",backState:Q==="true"?void 0:{order:N.state.order,productsFilter:N.state.productsFilter},showBackButton:!0}),s.jsx("div",{className:"flex w-full flex-col gap-4 p-4 pb-20 lg:pt-18",children:s.jsx("div",{className:"flex w-full flex-col gap-4",children:n.map((E,D)=>s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsx("div",{className:"border-b border-gray-200",children:s.jsx("span",{className:"text-lg font-bold text-gray-900",children:E.name})}),E.products.map((e,_)=>s.jsxs(Es,{className:"border-primary/50 shadow-sm p-0 gap-0",children:[s.jsx(os,{className:"bg-primary flex items-center justify-between px-3 py-2 rounded-t-lg",children:s.jsxs(Ds,{className:"flex items-center gap-2 p-0 m-0 font-bold text-white",children:[s.jsx("span",{className:"bg-white rounded-full text-sm px-3 text-primary",children:e.CODIGO_INTEGRACAOO||e.CODIGO||e.PROD_CODIGO}),s.jsx("span",{className:"text-lg",children:e.PRODUTO||e.PROD_DESCR})]})}),s.jsxs(ts,{className:"flex flex-col p-2",children:[s.jsxs("div",{className:"flex flex-col gap-1 text-sm text-gray-700",children:[s.jsxs("p",{children:[s.jsx("strong",{children:"Endereço: "}),e.ENDERECO," - ",e.CIDADE," - ",e.UF]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Armazém: "}),e.ESIN_ARMAZEM||"N/A"]}),s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("p",{children:[s.jsx("strong",{children:"Lote: "})," ",e.LOTE]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Série: "})," ",e.SERIE]})]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Qtde: "})," ",e.QTDE_PEDIDO||e.QTDE_LIDO||e.QTDE_ORDER]})]}),s.jsxs("div",{className:"flex items-center justify-start gap-2 border-gray-100",children:[s.jsxs("p",{className:"text-sm",children:[s.jsx("strong",{children:"Valor unitário: "})," ",z(t(e.VALOR))]}),!T&&s.jsx(j,{onClick:()=>{const l=`valor${_}_${D}`;f(l,t(e.VALOR)),f("index",_),f("prod",e),f("indexCompany",D),q(l),y(`${_}_${D}`)},variant:"ghost",size:"icon",className:"size-7 rounded-full bg-primary hover:bg-primary/95",children:s.jsx(Is,{size:16,className:"text-white"})})]}),b===`${_}_${D}`&&s.jsx(G,{...L,children:s.jsxs("form",{className:"flex flex-col gap-2",onSubmit:J(K),children:[s.jsx(F,{control:L.control,name:`valor${_}_${D}`,render:({field:l})=>s.jsxs(B,{children:[s.jsx($,{children:"Informe o valor unitário"}),s.jsx(U,{children:s.jsx(ls,{id:`valor${_}_${D}`,...l,autoFocus:!0})})]})}),s.jsxs(j,{type:"submit",className:"w-full gap-2",children:[s.jsx(_s,{size:20}),"Confirmar"]})]})}),e.PED_VALOR&&s.jsxs("div",{className:"flex items-center justify-between gap-2 border-t border-primary/50 mt-2",children:[s.jsx("span",{className:"text-base font-bold text-gray-900",children:"Valor total"}),s.jsx("span",{className:"text-base font-bold text-primary",children:z(e.PED_VALOR)})]})]})]},`${e.PROD_ID}_${e.SERIE}`)),!T&&s.jsx(G,{...v,children:s.jsx("form",{className:"mt-2 w-full",children:s.jsx(F,{control:v.control,name:"ATD_OBS",render:({field:e})=>s.jsxs(B,{children:[s.jsx($,{children:"Observação do pedido"}),s.jsx(U,{children:s.jsx(ns,{...e,maxLength:300,rows:4,onChange:_=>{e.onChange(_);const l=_.target.value;n[D].OBSERVATION=l,h(n)}})})]})})})})]},E.name))})}),s.jsx("footer",{className:"fixed bottom-0 left-0 right-0 z-50 flex items-center justify-end w-full border-t bg-primary p-4",children:s.jsxs(j,{variant:"secondary",className:"text-primary text-base",onClick:Z,disabled:!n||n&&n.length===0||T,children:["Finalizar pedido",s.jsx(cs,{size:20})]})})]})}export{Cs as default};
