import{I as Y,L as r,K as le,N as e,O as b,P as Me,X as Ae,V as X,S as u,R as se,W as ne,Y as Ke,Z as ye,_ as De,J as Ge,a0 as je,a1 as Le,a2 as be,a3 as oe,a4 as Ce}from"./index-CYXlB6di.js";import{C as ve}from"./calendar-CbLc9Ubs.js";import{D as Ie,a as he,b as xe,c as fe,d as Ne}from"./dialog-LwW192j0.js";import{I as ce}from"./input-B9CoZ-jW.js";import{L as Z}from"./label-DZv4CB4a.js";import{P as Oe,a as Fe,b as Te}from"./popover-BaGBQ11z.js";import{g as ae,h as we,u as Se,l as Ee,a as Re,C as ke,s as ze,e as Ue}from"./homeServices-C-QDDkvr.js";import{C as Q}from"./camera-4vcxwOoC.js";import{C as Be}from"./calendar-t7hk2tVO.js";import{f as J}from"./format-BBYAYFtJ.js";import{d as de,w as He,g as Pe,a as $e,f as me}from"./timesAndDates-BA0J74pm.js";import{h as qe}from"./handleApiError-Mr_6qIMG.js";import{C as Je}from"./clock-IyxNcF_P.js";import{T as ue}from"./timer-CktEQguA.js";import{R as We}from"./refresh-cw-CufRmD9-.js";import{C as Ve}from"./check-check-Chns-tfq.js";import{S as Qe}from"./store-D1vNHo_u.js";import"./startOfDay-Be0wd0F5.js";import"./addDays-CyOWDzeI.js";import"./chevron-down-BrwHMvvE.js";import"./index-BqX2kfYm.js";import"./index-DekvUVLv.js";import"./index-j1y6my5Y.js";import"./apiEndpoints-aSQtSIWE.js";import"./currency-CxFzcO-j.js";import"./useQuery-hx1aMKYH.js";import"./pt-BR-mIVN-mbg.js";const Ze=[["path",{d:"M15.6 2.7a10 10 0 1 0 5.7 5.7",key:"1e0p6d"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M13.4 10.6 19 5",key:"1kr7tw"}]],Xe=Y("circle-gauge",Ze);const Ye=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],ea=Y("copy",Ye);const aa=[["circle",{cx:"12",cy:"16",r:"1",key:"1au0dj"}],["rect",{x:"3",y:"10",width:"18",height:"12",rx:"2",key:"6s8ecr"}],["path",{d:"M7 10V7a5 5 0 0 1 10 0v3",key:"1pqi11"}]],pe=Y("lock-keyhole",aa);const ta=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],sa=Y("play",ta);const na=[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]],ia=Y("smartphone",na);function ra({open:s,onOpenChange:d,currentDrivenOdometro:l,HodometroD:T}){const[h,P]=r.useState(new Date),[p,A]=r.useState({img:l?.GKM_KM_INICIAL_FOTO||null,fileExtension:""}),[f,g]=r.useState({img:l?.GKM_KM_FINAL_FOTO||null,fileExtension:""}),[a,w]=r.useState(l||{GKM_USR_AGENDA_ID:null,GKM_DATA:null,GKM_KM_INICIAL:null,GKM_KM_INICIAL_DATA:null,GKM_KM_INICIAL_FOTO:null,GKM_KM_INICIAL_LATITUDE:null,GKM_KM_INICIAL_LONGITUDE:null,GKM_KM_FINAL:null,GKM_KM_FINAL_DATA:null,GKM_KM_FINAL_FOTO:null,GKM_KM_FINAL_LATITUDE:null,GKM_KM_FINAL_LONGITUDE:null,GAA_KM_INICIAL:null,GAA_KM_FINAL:null}),{showLoading:C,hideLoading:I,isLoading:v}=le();async function S(i,n=1920,_=.7){return new Promise((G,j)=>{const x=new FileReader;x.readAsDataURL(i),x.onload=O=>{const D=new Image;D.src=O.target?.result,D.onload=()=>{const o=document.createElement("canvas");let z=D.width,E=D.height;z>n&&(E=E*n/z,z=n),o.width=z,o.height=E,o.getContext("2d")?.drawImage(D,0,0,z,E),o.toBlob(ee=>{ee?G(ee):j(new Error("Falha ao comprimir imagem"))},"image/jpeg",_)},D.onerror=j},x.onerror=j})}async function q(i){try{C();const n=i.target.files?.[0];if(n){const _=await S(n,1920,.7),G=n.name.substring(n.name.lastIndexOf("."),n.name.length),j=_.size<n.size?_:n;return{img:await Ke(j),fileExtension:G}}}catch{u("Não foi possível salvar a imagem")}finally{I()}}async function t(){try{const i=X();if(i){C();const{latitude:n,longitude:_,error:G}=await ae();if(!n||!_){u(G||"Não foi possível buscar a localização atual, tente novamente"),I();return}const j=i.empresaId,x=i.codigoUsuario,O=i.empresaCnpj;if(!Number(a.GAA_KM_INICIAL)&&Number(a.GAA_KM_INICIAL)===0&&!a.GAA_KM_FINAL&&a.GAA_KM_FINAL===0){u("Informe os dados do hodômetro");return}if(a.GAA_KM_FINAL&&a.GAA_KM_FINAL<a.GAA_KM_INICIAL){u("A quilometragem do fim do dia não pode ser menor que a do início");return}if(!a?.GKM_KM_INICIAL_FOTO&&p.img&&(a.GKM_KM_INICIAL_FOTO=await m(p.img,`Foto_inicio${p.fileExtension}`,"km inicio dia",x,O)),!a?.GKM_KM_FINAL_FOTO&&f.img&&(a.GKM_KM_FINAL_FOTO=await m(f.img,`Foto_fim${f.fileExtension}`,"km fim dia",x,O)),a?.GAA_KM_INICIAL&&!a.GKM_KM_INICIAL_FOTO){u("Adicione a foto do início do dia");return}if(a?.GAA_KM_FINAL&&!a.GKM_KM_FINAL_FOTO){u("Adicione a foto do fim do dia");return}const D={GKM_USR_AGENDA_ID:x,GKM_DATA:J(h,"yyyy-MM-dd"),GKM_KM_INICIAL:a?.GAA_KM_INICIAL,GKM_KM_INICIAL_DATA:a?.GKM_KM_INICIAL_FOTO&&!a?.GKM_KM_INICIAL_DATA?J(h,"yyyy-MM-dd hh:mm:ss"):a?.GKM_KM_INICIAL_DATA,GKM_KM_INICIAL_FOTO:a.GKM_KM_INICIAL_FOTO,GKM_KM_INICIAL_LATITUDE:a?.GKM_KM_INICIAL_FOTO&&!a?.GKM_KM_INICIAL_LATITUDE?n:a?.GKM_KM_INICIAL_LATITUDE,GKM_KM_INICIAL_LONGITUDE:a?.GKM_KM_INICIAL_FOTO&&!a?.GKM_KM_INICIAL_LONGITUDE?_:a?.GKM_KM_INICIAL_LONGITUDE,GKM_KM_FINAL:a?.GAA_KM_FINAL,GKM_KM_FINAL_DATA:a?.GKM_KM_FINAL_FOTO&&!a?.GKM_KM_FINAL_DATA?J(h,"yyyy-MM-dd hh:mm:ss"):a?.GKM_KM_FINAL_DATA,GKM_KM_FINAL_FOTO:a.GKM_KM_FINAL_FOTO,GKM_KM_FINAL_LATITUDE:a?.GKM_KM_FINAL_FOTO&&!a?.GKM_KM_FINAL_LATITUDE?n:a?.GKM_KM_FINAL_LATITUDE,GKM_KM_FINAL_LONGITUDE:a?.GKM_KM_FINAL_FOTO&&!a?.GKM_KM_FINAL_LONGITUDE?_:a?.GKM_KM_FINAL_LONGITUDE},o=await se.post(`v2/trade/kmdriven/${j}/${x}`,D),{sucess:z,data:E}=o.data;if(z){let W=E;Array.isArray(E)&&(W=E[0]),a?.GKM_KM_FINAL_FOTO?ne("hodometroActive",!1):ne("hodometroActive",!0),ne("currentDrivenOdometro",W),w(W),d(!1),u("Salvo com sucesso",1)}}}catch{u("Não foi possível salvar")}finally{I()}}async function m(i,n,_,G,j){try{const x={fileName:n,id:1,imageData:i,uniqueid:_},O="/v2/trade/sync/image/"+j+"/"+G,D=await se.post(O,x,{timeout:30*1e3}),{data:o}=D.data;if(ye(o))return o.urlPath}catch{u("Não foi possível salvar a foto")}}async function N(i){try{P(i);const n=X();if(n){C();const{latitude:_,longitude:G,error:j}=await ae();if(!_||!G){u(j||"Não foi possível buscar a localização atual, tente novamente"),I();return}const x=n.empresaId,O=n.codigoUsuario,D=await se.get(`v2/trade/kmdriven/${x}/${O}`,{params:{data:J(i,"dd-MM-yyyy"),usuarioAgenda:O}}),{data:o}=D.data;o&&(o&&o.length>0?(o[0].GAA_KM_INICIAL=o[0].GKM_KM_INICIAL,o[0].GAA_KM_FINAL=o[0].GKM_KM_FINAL,A({img:o[0].GKM_KM_INICIAL_FOTO,fileExtension:""}),g({img:o[0].GKM_KM_FINAL_FOTO,fileExtension:""}),w(o[0]),M("km_initial",o[0].GKM_KM_INICIAL),M("km_final",o[0].GKM_KM_FINAL)):(w({GKM_USR_AGENDA_ID:null,GKM_DATA:null,GKM_KM_INICIAL:null,GKM_KM_INICIAL_DATA:null,GKM_KM_INICIAL_FOTO:null,GKM_KM_INICIAL_LATITUDE:null,GKM_KM_INICIAL_LONGITUDE:null,GKM_KM_FINAL:null,GKM_KM_FINAL_DATA:null,GKM_KM_FINAL_FOTO:null,GKM_KM_FINAL_LATITUDE:null,GKM_KM_FINAL_LONGITUDE:null,GAA_KM_INICIAL:null,GAA_KM_FINAL:null}),M("km_initial",""),M("km_final",""),A({img:null,fileExtension:""}),g({img:null,fileExtension:""})))}}catch{u("Não foi possível buscar os dados desse dia")}finally{I()}}function M(i,n){const _=document.getElementById(i);_&&_.type==="number"?_.value=n:console.error("O elemento não foi encontrado ou não é um input do tipo number")}const K=r.useRef(!1);r.useEffect(()=>{K.current||(async function(){K.current=!0,N(new Date)})()},[]);const L=async i=>{const n=await q(i);n&&A({img:n.img,fileExtension:n.fileExtension})},y=async i=>{const n=await q(i);n&&g({img:n.img,fileExtension:n.fileExtension})};return e.jsx(Ie,{open:s,onOpenChange:d,children:e.jsxs(he,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:[e.jsx(xe,{className:"bg-linear-to-r from-primary to-primary/80 text-white p-6 -m-6 mb-6 rounded-t-lg",children:e.jsxs(fe,{className:"flex items-center gap-3 text-xl",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/20 flex items-center justify-center",children:e.jsx(Q,{className:"w-5 h-5"})}),"Dados do Hodômetro"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"Data"}),e.jsxs(Oe,{children:[e.jsx(Fe,{asChild:!0,children:e.jsxs(b,{disabled:!l,variant:"outline",className:Me("w-full justify-start text-left font-normal h-12",!h&&"text-muted-foreground"),children:[e.jsx(Be,{className:"mr-2 h-4 w-4"}),h?J(h,"dd/MM/yyyy"):e.jsx("span",{children:"Selecione uma data"})]})}),e.jsx(Te,{className:"w-auto p-0",children:e.jsx(ve,{mode:"single",selected:h,onSelect:i=>i&&N(i),initialFocus:!0})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"km_initial",className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"KM inicial do dia"}),e.jsx(ce,{id:"km_initial",type:"number",placeholder:"Digite a quilometragem inicial",disabled:a.GKM_ID===l?.GKM_ID&&l?.GKM_KM_INICIAL,value:a.GAA_KM_INICIAL||"",onChange:i=>w({...a,GAA_KM_INICIAL:i.target.value}),className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"photo-inicial",className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"Foto do início do dia"}),e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-8 hover:border-primary transition-colors",children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4",children:[p.img?e.jsx("img",{src:p.img,alt:"Foto inicial",className:"max-w-full h-auto rounded-lg"}):e.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center",children:e.jsx(Q,{className:"w-10 h-10 text-primary"})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-zinc-600 mb-1",children:"Clique para adicionar uma foto"})}),e.jsx("input",{id:"photo-inicial",type:"file",accept:"image/*",capture:T?void 0:"environment",disabled:a.GKM_ID===l?.GKM_ID&&l?.GKM_KM_INICIAL_FOTO,onChange:L,className:"hidden"}),e.jsxs(b,{type:"button",variant:"outline",onClick:()=>document.getElementById("photo-inicial")?.click(),className:"gap-2",disabled:v||a.GKM_ID===l?.GKM_ID&&l?.GKM_KM_INICIAL_FOTO,children:[e.jsx(Q,{size:16}),"Selecionar foto"]})]})})]}),a?.GKM_KM_INICIAL!==null&&a?.GKM_KM_INICIAL_FOTO&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"km_final",className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"KM final do dia"}),e.jsx(ce,{id:"km_final",type:"number",placeholder:"Digite a quilometragem final",disabled:a.GKM_ID===l?.GKM_ID&&l?.GKM_KM_FINAL,value:a.GAA_KM_FINAL||"",onChange:i=>w({...a,GAA_KM_FINAL:i.target.value}),className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"photo-final",className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"Foto do fim do dia"}),e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-8 hover:border-primary transition-colors",children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4",children:[f.img?e.jsx("img",{src:f.img,alt:"Foto final",className:"max-w-full h-auto rounded-lg"}):e.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center",children:e.jsx(Q,{className:"w-10 h-10 text-primary"})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-zinc-600 mb-1",children:"Clique para adicionar uma foto"})}),e.jsx("input",{id:"photo-final",type:"file",accept:"image/*",capture:T?void 0:"environment",onChange:y,disabled:a.GKM_ID===l?.GKM_ID&&l?.GKM_KM_FINAL_FOTO,className:"hidden"}),e.jsxs(b,{type:"button",variant:"outline",onClick:()=>document.getElementById("photo-final")?.click(),className:"gap-2",disabled:v||a.GKM_ID===l?.GKM_ID&&l?.GKM_KM_FINAL_FOTO,children:[e.jsx(Q,{size:16}),"Selecionar foto"]})]})})]})]})]}),e.jsxs(Ne,{className:"gap-2",children:[e.jsxs(b,{type:"button",variant:"outline",onClick:()=>d(!1),className:"gap-2",disabled:v,children:[e.jsx(Ae,{size:16}),"Fechar"]}),e.jsxs(b,{type:"button",onClick:t,className:"gap-2 min-w-48 bg-primary",disabled:v||a.GKM_ID===l?.GKM_ID&&l?.GKM_KM_FINAL_FOTO,children:[e.jsx(Q,{size:16}),v?"Carregando...":"Salvar"]})]})]})})}function la({open:s,onOpenChange:d}){const[l,T]=r.useState(null),{showLoading:h,hideLoading:P}=le();async function p(){const A=X();if(!A){u("Sessão expirada");return}const f=A.email;h("Gerando código");const g=await we(f);P(),g&&T(g)}return e.jsx(Ie,{open:s,onOpenChange:d,children:e.jsxs(he,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:[e.jsx(xe,{className:"bg-linear-to-r from-primary to-primary/80 text-white p-6 -m-6 mb-6 rounded-t-lg",children:e.jsxs(fe,{className:"flex items-center gap-3 text-xl",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/20 flex items-center justify-center",children:e.jsx(pe,{className:"w-5 h-5"})}),"Código para limpeza de dados locais"]})}),e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4",children:[e.jsxs("p",{className:"font-medium text-center text-zinc-600",children:["Segue abaixo o codigo para liberação de limpeza de dados locais, este código pode ser utilizado apenas ",e.jsx("strong",{children:"UMA"})," vez"]}),l&&e.jsxs("span",{className:"bg-primary/20 py-2 px-6 rounded-md border-dotted border-primary text-primary text-2xl font-bold flex items-center justify-center",children:[l,e.jsx("button",{type:"button",onClick:()=>{navigator.clipboard.writeText(l),u("Código copiado!",1)},className:"ml-2 p-1 rounded-md hover:bg-primary/30 transition-colors",children:e.jsx(ea,{size:24})})]}),e.jsx(b,{className:"min-w-48",onClick:p,children:"Gerar código"})]}),e.jsx(Ne,{className:"gap-2 mt-6",children:e.jsxs(b,{type:"button",variant:"outline",onClick:()=>d(!1),className:"gap-2",children:[e.jsx(Ae,{size:16}),"Fechar"]})})]})})}function ie({stopWatch:s,variant:d}){return d==="day-finalized"?e.jsx("div",{className:"w-full mb-4 overflow-hidden rounded-xl border border-red-900/30 bg-red-950 shadow-lg",children:e.jsxs("div",{className:"flex items-start gap-3 p-4",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-lg bg-red-900 text-red-300",children:e.jsx("i",{children:e.jsx(Je,{size:20})})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"text-sm font-semibold text-red-50",children:"Horário de Atendimento Encerrado"}),e.jsx("p",{className:"text-xs text-red-100",children:"O expediente de hoje foi finalizado"})]})]})}):d==="waiting-end"?e.jsxs("div",{className:"w-full mb-4 overflow-hidden rounded-xl border border-orange-900/30 bg-orange-950 shadow-lg",children:[e.jsxs("div",{className:"flex items-start gap-3 p-4",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-lg bg-orange-900 text-orange-300",children:e.jsx("i",{children:e.jsx(ue,{size:20})})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"text-sm font-semibold text-orange-50",children:"Encerrando em Breve"}),e.jsx("p",{className:"text-xs text-orange-100",children:"Finalize seus atendimentos pendentes"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-black/20 px-4 py-3 gap-1",children:[e.jsx("span",{className:"text-base font-medium text-orange-100",children:"Encerramento em"}),e.jsxs("span",{className:"font-mono text-xl font-bold tracking-wider text-orange-100",children:[s.hours.toString().padStart(2,"0"),":",s.minutes.toString().padStart(2,"0"),":",s.seconds.toString().padStart(2,"0")]})]})]}):e.jsxs("div",{className:"w-full mb-4 overflow-hidden rounded-xl border border-purple-900/30 bg-purple-950 shadow-lg",children:[e.jsxs("div",{className:"flex items-start gap-3 p-4",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-lg bg-purple-900 text-purple-300",children:e.jsx("i",{children:e.jsx(ue,{size:20})})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"text-sm font-semibold text-purple-50",children:"Aguardando Horário de Início"}),e.jsx("p",{className:"text-xs text-purple-100",children:"O atendimento será liberado em breve"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-black/20 px-4 py-3 gap-1",children:[e.jsx("span",{className:"text-base font-medium text-purple-100",children:"Início em"}),e.jsxs("span",{className:"font-mono text-xl font-bold tracking-wider text-purple-100",children:[s.hours.toString().padStart(2,"0"),":",s.minutes.toString().padStart(2,"0"),":",s.seconds.toString().padStart(2,"0")]})]})]})}const oa=30*1e3;function re(s){const d=Math.abs(s);return{totalTimeInSeconds:d,hours:Math.floor(d/3600)%24,minutes:Math.floor(d/60)%60,seconds:d%60}}function _e(s){if(!s)return null;const d=new Date,[l,T,h]=s.split(":",3).map(Number);return d.setHours(l,T,h||0,0),d}function ca(s){return He(new Date)!=="Sábado"?s:{...s,INICIO_JORNADA:s.INICIO_JORNADA_SA??s.INICIO_JORNADA,FIM_JORNADA:s.FIM_JORNADA_SA??s.FIM_JORNADA,INICIO_PARADA1:s.INICIO_PARADA1_SA??s.INICIO_PARADA1,FIM_PARADA1:s.FIM_PARADA1_SA??s.FIM_PARADA1,FORCAR_PARADA1:s.FORCAR_PARADA1_SA??s.FORCAR_PARADA1}}function da(){const[s,d]=r.useState(re(0)),[l,T]=r.useState(!1),[h,P]=r.useState(!1),[p,A]=r.useState(!1),f=r.useRef(null),g=r.useRef(null),a=r.useRef(null),w=r.useRef(null),C=r.useRef(!1),I=r.useCallback(()=>{f.current&&(clearInterval(f.current),f.current=null),g.current&&(clearInterval(g.current),g.current=null)},[]),v=r.useCallback(m=>{d(re(m))},[]),S=r.useCallback(m=>{const N=new Date,M=a.current,K=w.current;if(!M||!K){A(!0);return}const L=de(N,M),y=de(N,K);if(y>0){A(!1),T(!0),I();return}if(m)A(!0);else{if(L<0){A(!1),v(L);return}A(!0)}y>=-1800&&y!==0?(P(!0),v(y)):(P(!1),(m||L>=0)&&I())},[v,I]),q=r.useCallback(m=>{I(),f.current=setInterval(()=>{d(N=>N.totalTimeInSeconds>0?re(N.totalTimeInSeconds-1):(S(m),N))},1e3),g.current=setInterval(()=>{S(m)},oa)},[I,S]),t=r.useCallback(m=>{if(!m?.HORARIOS_TRABALHO)return m;const N=m.HORARIOS_TRABALHO;if(Object.keys(N).length===0)return A(!0),{...m,HORARIOS_TRABALHO:{...N,Released:!0}};const M=ca(N),K=_e(M.INICIO_JORNADA),L=_e(M.FIM_JORNADA);if(a.current=K,w.current=L,!K||!L)return A(!0),{...m,HORARIOS_TRABALHO:{...M,Released:!0}};const y=!m.endAttendances&&!!m.startAttendances;return S(y),C.current||(q(y),C.current=!0),{...m,HORARIOS_TRABALHO:{...M,Released:p}}},[S,q,p]);return r.useEffect(()=>()=>{I(),C.current=!1},[I]),{stopWatch:s,isDayFinalized:l,isCheckMinutesForEnd:h,isReleased:p,initializeSchedule:t}}function Ra(){const[s,d]=r.useState(null),[l,T]=r.useState(!1),[h,P]=r.useState(null),[p,A]=r.useState(!1),[f,g]=r.useState(!1),[a,w]=r.useState({GKM_USR_AGENDA_ID:null,GKM_DATA:null,GKM_KM_INICIAL:null,GKM_KM_INICIAL_DATA:null,GKM_KM_INICIAL_FOTO:null,GKM_KM_INICIAL_LATITUDE:null,GKM_KM_INICIAL_LONGITUDE:null,GKM_KM_FINAL:null,GKM_KM_FINAL_DATA:null,GKM_KM_FINAL_FOTO:null,GKM_KM_FINAL_LATITUDE:null,GKM_KM_FINAL_LONGITUDE:null}),{stopWatch:C,isDayFinalized:I,isCheckMinutesForEnd:v,isReleased:S,initializeSchedule:q}=da(),{data:t,isLoading:m,isFetching:N}=Se(),M=De(),K=Ge(),{showLoading:L,hideLoading:y}=le();async function i(){try{if(!await be({title:"Iniciar atendimento",component:e.jsx("span",{className:"font-bold text-lg text-center",children:"Deseja iniciar o atendimento?"}),confirm:"Iniciar"}))return;L("Iniciando atendimento");const R=s?.gmovelHodometro,U=await oe("currentDrivenOdometro");if(R&&t?.scheduleData!==void 0&&t?.scheduleData.status===void 0&&!t?.scheduleData?.sucessStarted&&(!U||!U.GKM_KM_INICIAL_FOTO&&!U.GKM_KM_INICIAL)){u("Para iniciar o dia, é necessário informar o KM inicial, e a foto");return}const{latitude:B,longitude:k,error:H}=await ae();if(!B||!k){u(H||"Não foi possível buscar a localização atual, tente novamente"),y();return}if(t?.scheduleData.status===void 0){const V=me(new Date),F=await ze(t?.scheduleData,t?.scheduleData?.GAA_ID,B,k,V);if(F===void 0){u(`Não é possível continuar, o dia não foi iniciado.
Verifique sua conexão com a internet e se seu GPS está ativo`);return}if(F&&F.sucessStarted){F.status=2;const $={};$.dataHoraInicio=V,$.latitude=B,$.longitude=k,F.startAttendances=$,await Ce(F),K("/customer-service")}else{u("Não foi possível iniciar o atendimento, tente novamente");return}}}catch(c){qe(c,!1)}finally{y()}}function n(c){M.setQueryData(["getScheduleHome"],()=>c)}async function _(){const{latitude:c,longitude:R,error:U}=await ae();if(!c||!R){u(U||"Não foi possível buscar a localização atual, tente novamente"),y();return}const k=X().gmovelHodometro,H=await oe("currentDrivenOdometro"),V=J(new Date,"dd/MM/yyyy"),F=H?.GKM_KM_INICIAL_DATA?J(new Date(H?.GKM_KM_INICIAL_DATA),"dd/MM/yyyy"):null;if(k&&!H&&!H?.GKM_KM_FINAL&&!H?.GKM_KM_FINAL_FOTO&&F&&V!==F){u("Para finalizar o dia, é necessário informar o KM final, e a foto");return}L("Finalizando o dia");const $=me(new Date),te=await Ue(t?.scheduleData,t?.scheduleData?.GAA_ID,c,R,$,L);y(),te&&K("/expired")}const G=r.useRef(!1);r.useEffect(()=>((async function(){if(G.current)return;const R=X();if(d(R),t){const U=await Ee();P(U),G.current=!0;const B=q(t.scheduleData);if(B!==t.scheduleData&&(t.scheduleData=B,n(t)),R.gmovelHodometro||R.gmovelHodometroD){const k=await Re(t?.scheduleData);k&&w(k)}}})(),()=>{G.current=!1}),[t]);const j=t?.allScheduleData&&t?.allScheduleData.length===0||!t,x=t?.allScheduleData&&t.allScheduleData.length>0,O=h!==void 0&&t?.scheduleData&&t?.scheduleData?.GAA_DTA_AGENDA===h?.GAA_DTA_AGENDA,D=t&&t?.scheduleData&&t?.scheduleData?.GAA_DTA_AGENDA===Pe()&&t?.scheduleData?.CLIENTES[0]?.SEQ_PADRAO!==-1,o=t?.scheduleData&&Object.keys(t?.scheduleData?.HORARIOS_TRABALHO).length!==0,z=o&&!t?.scheduleData?.startAttendances?!S||I:!1,E=o&&!S&&!I,W=t?.scheduleData?.CLIENTES&&t.scheduleData.CLIENTES.length>0,ee=s?.gmovelHodometro||s?.gmovelHodometroD,ge=[...t?.allScheduleData||[]].sort((c,R)=>{const[U,B,k]=c.GAA_DTA_AGENDA.split("/").map(Number),[H,V,F]=R.GAA_DTA_AGENDA.split("/").map(Number),$=new Date(k,B-1,U).getTime(),te=new Date(F,V-1,H).getTime();return $-te});return m||N?e.jsx(je,{loadingTrue:!0}):e.jsxs("div",{className:"min-h-full background-pages",children:[e.jsxs("main",{className:"max-w-4xl mx-auto px-2 pb-4 pt-4 lg:pt-18",children:[e.jsxs("div",{className:"flex items-center gap-3 justify-start w-1/3",children:[s?.isAdmin&&e.jsx(b,{onClick:()=>A(!0),variant:"default",className:"flex-1 gap-2 size-10 rounded-full",children:e.jsx(pe,{size:20,className:"text-white"})}),ee&&e.jsx(b,{onClick:()=>g(!0),variant:"default",className:"flex-1 gap-2 size-10 rounded-full",disabled:!t||!t?.scheduleData,children:e.jsx(Xe,{size:20,className:"text-white"})}),e.jsx(b,{onClick:()=>K("/service-admin"),variant:"default",className:"flex-1 gap-2 size-10 rounded-full",children:e.jsx(ia,{size:20,className:"text-white"})})]}),e.jsx("div",{className:"flex items-center justify-center my-3 text-center",children:e.jsx("h1",{className:"text-3xl font-bold text-primary",children:"Agenda"})}),j&&e.jsxs("div",{className:"flex flex-col gap-2 mt-6",children:[e.jsxs(b,{className:"py-6 text-base",onClick:()=>K(0),children:[e.jsx("i",{children:e.jsx(We,{size:20,className:"text-white"})}),"Atualizar"]}),e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border border-[#d5b5e3] p-6 text-center",children:e.jsx("h2",{className:"text-xl font-bold text-primary",children:"Sem atividades agendadas"})})]}),x&&e.jsx("div",{className:"bg-white/50 backdrop-blur-sm rounded-2xl shadow-xs mb-4 flex gap-3 overflow-x-auto p-2 pb-3 snap-x snap-mandatory scroll-smooth",children:ge.map(c=>e.jsx("button",{onClick:()=>{t.scheduleData=c,n(t),T(!l)},className:`flex-1 py-4 px-4 rounded-xl transition-all border min-w-[130px] snap-center ${t?.scheduleData?.GAA_ID===c.GAA_ID?"bg-primary text-white shadow-lg scale-[1.02] border-primary":"bg-white text-primary border-zinc-200 hover:border-primary/30 hover:bg-primary/5 shadow-sm"}`,children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`text-xs font-medium uppercase tracking-wider mb-1 ${t?.scheduleData?.GAA_ID===c.GAA_ID?"text-white/80":"text-zinc-500"}`,children:$e(c.GAA_DTA_AGENDA)}),e.jsxs("span",{className:`text-lg font-bold ${t?.scheduleData?.GAA_ID===c.GAA_ID?"text-white":"text-zinc-900"}`,children:[c.GAA_DTA_AGENDA.split("/")[0],"/",c.GAA_DTA_AGENDA.split("/")[1]]})]})},c.GAA_DTA_AGENDA))}),O&&e.jsxs(b,{onClick:_,className:" w-full py-6 my-3",children:[e.jsx(Ve,{size:22}),"Finalizar dia"]}),D&&e.jsx("button",{disabled:z,onClick:async()=>{!t.scheduleData.status&&!t.scheduleData.sucessStarted?await i():K("/customer-service")},className:Le("w-full bg-white font-medium text-primary py-4 rounded-2xl my-3 drop-shadow-sm drop-shadow-primary transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2",t.scheduleData.status&&t.scheduleData.sucessStarted&&"bg-linear-to-br from-primary/75 via-primary to-primary/75 text-white"),children:!t.scheduleData.status&&!t.scheduleData.sucessStarted?e.jsxs(e.Fragment,{children:[e.jsx(ke,{size:20}),e.jsx("span",{className:"text-lg",children:"Iniciar atendimento"})]}):e.jsxs(e.Fragment,{children:[e.jsx(sa,{size:20}),e.jsx("span",{className:"text-lg",children:"Continuar atendimento"})]})}),E&&e.jsx(ie,{stopWatch:C,variant:"waiting-start"}),I&&e.jsx(ie,{stopWatch:C,variant:"day-finalized"}),v&&e.jsx(ie,{stopWatch:C,variant:"waiting-end"}),W&&e.jsx("div",{className:"space-y-4",children:t.scheduleData.CLIENTES.map(c=>e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border border-[#d5b5e3] hover:shadow-lg transition-all hover:border-[#bf8fd6] cursor-pointer group overflow-hidden",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"shrink-0 w-12 h-12 rounded-xl bg-linear-to-br from-primary to-primary/75 flex items-center justify-center",children:e.jsx(Qe,{size:24,className:"text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"inline-block px-2 py-0.5 bg-primary text-white text-xs font-medium rounded-full",children:c.CLI_CODIGO}),e.jsx("h3",{className:"text-gray-900 font-bold",children:c.CLI_NOME_FANTASIA})]}),e.jsxs("p",{className:"text-sm text-gray-500 mb-2",children:["(",c.CLI_RAZAO_SOCIAL,")"]}),e.jsx("p",{className:"text-sm text-gray-600",children:c.CLI_ENDERECO})]})]})})},c.CLI_CODIGO))})]}),f&&e.jsx(ra,{open:f,onOpenChange:g,currentDrivenOdometro:a,HodometroD:s?.gmovelHodometroD||!1}),p&&e.jsx(la,{open:p,onOpenChange:()=>A(!1)})]})}export{Ra as default};
