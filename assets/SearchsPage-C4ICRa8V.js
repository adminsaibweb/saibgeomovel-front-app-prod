import{I as w,V as G,R as q,J as re,L as g,K as oe,U as ie,ad as R,N as a,a0 as ne,aa as le,a1 as ce,ae as de,af as ue,ab as pe,S as m,ac as S,a2 as Ae}from"./index-YngUMXNg.js";import{u as fe}from"./useQuery-PaZTN53n.js";import{C as me,g as k,c as he,p as N,b as Ee,f as Ne,i as Ie}from"./homeServices-CpeKEX-f.js";import{u as Te,F as xe}from"./useForcedBreak-AE-Klfdy.js";import{a as F,f as M}from"./currency-CxFzcO-j.js";import{b as Se}from"./timesAndDates-DyUV-en1.js";import{u as Q}from"./useLocalStorage-DOVSTlkF.js";import{h as B}from"./handleApiError-B5XCkBcY.js";import{R as Ce}from"./refresh-cw-jQzGVHoK.js";import"./apiEndpoints-aSQtSIWE.js";import"./format-BBYAYFtJ.js";import"./startOfDay-Be0wd0F5.js";import"./timer--7ll23NN.js";import"./clock-DtKml6_n.js";import"./addDays-CyOWDzeI.js";import"./pt-BR-mIVN-mbg.js";const Oe=[["path",{d:"M16 2v4",key:"4m81vk"}],["path",{d:"M21 11.75V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7.25",key:"1jrsq6"}],["path",{d:"m22 22-1.875-1.875",key:"13zax7"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 2v4",key:"1cmpym"}],["circle",{cx:"18",cy:"18",r:"3",key:"1xkwt0"}]],ge=w("calendar-search",Oe);const Re=[["path",{d:"M12 16h.01",key:"1drbdi"}],["path",{d:"M12 8v4",key:"1got3b"}],["path",{d:"M15.312 2a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586l-4.688-4.688A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2z",key:"1fd625"}]],be=w("octagon-alert",Re);const Le=[["path",{d:"M10 15H6a4 4 0 0 0-4 4v2",key:"1nfge6"}],["path",{d:"m14.305 16.53.923-.382",key:"1itpsq"}],["path",{d:"m15.228 13.852-.923-.383",key:"eplpkm"}],["path",{d:"m16.852 12.228-.383-.923",key:"13v3q0"}],["path",{d:"m16.852 17.772-.383.924",key:"1i8mnm"}],["path",{d:"m19.148 12.228.383-.923",key:"1q8j1v"}],["path",{d:"m19.53 18.696-.382-.924",key:"vk1qj3"}],["path",{d:"m20.772 13.852.924-.383",key:"n880s0"}],["path",{d:"m20.772 16.148.924.383",key:"1g6xey"}],["circle",{cx:"18",cy:"15",r:"3",key:"gjjjvw"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],_e=w("user-cog",Le);async function ye(I,i){try{const E=G();if(!E)return[];const{empresaId:_,codigoUsuario:y}=E,b=await q.get(`v2/trade/pdv/events/${_}/${y}`,{params:{CLI_CODIGO:I,GEV_CLI_ID:i},timeout:3e3}),{data:T}=b.data;if(T)return T}catch(E){return B(E,[])}}function Ve(){const I=re(),[i,E]=g.useState(null),[,_,y]=Q("currentSearch"),[b,T]=Q("currentCustomer"),[x,H]=g.useState(null),[o,C]=g.useState(null),[z,$]=g.useState(!1),{showLoading:D,hideLoading:L}=oe(),{stopWatch:V,interruptForced:W,isBlocked:v}=Te(i),{data:P,isFetching:K,isLoading:J}=fe({queryKey:["events"],queryFn:()=>ye(o.CLI_CODIGO,o.CLI_ID),enabled:!!o});function Y(e){if(v){m("Não é possível iniciar pesquisas durante a pausa obrigatória",2);return}const s=x.findIndex(c=>c.GFP_ID===e.GFP_ID);_({todasPesquisas:x,pesquisa:e,cliente:o,posSearch:s}),e.DETALHAMENTO[0].PERGUNTAS?I("/single-question"):I("/group-question")}async function X(){if(v){m("Não é possível ir para a administração durante a pausa obrigatória",2);return}i&&!i.CONFERENCE&&!i.ORDERS&&(i.CONFERENCE={INVENTORY:[],PRODUCTS:[],lastAddPos:null,finishConference:null,orderAdmin:[],open:!0},i.ORDERS={ADD:[],INPROGRESS:[],NEW:[]},i.ORDERS_DIRECT={ADD:[],INPROGRESS:[],NEW:[]},await S(i)),I("/Admin")}async function Z(){try{if(v){m("Não é possível fazer check-out durante a pausa obrigatória",2);return}if(!await Ae({title:"Check-out",message:"Confirmar operação de check-out? está encerrando o atendimento nesse cliente"}))return;if(x.filter(t=>t.ALERTA_OBRIGATORIO===!1).length!==x.length){m("Ainda existem pesquisas obrigatórias não respondidas");return}D();const c=i?.HORARIOS_TRABALHO?.RAIO_ATENDIMENTO>=0;let r=o;if(c&&!o.checkoutLiberado){const{latitude:t,longitude:p}=await k();if(!t||!p){m("Não foi possível buscar a localização atual, tente novamente");return}const A=await he(o,i,t,p,!0);if(r=N(o,d=>{if(!A)d.alert=[{descricao:null,liberado:!0,lido:null}],d.checkoutLiberado=!0;else{const l=A.map(u=>({descricao:u.GTI_DESCRICAO,galId:u.GAL_ID,liberado:u.GTI_FLG_IMPEDE_ATD!==1,lido:u.GAL_FLG_STATUS===1,DISTANCE:u.DISTANCE,distanceNumber:u.distanceNumber}));d.alert=l,d.galId=l.find(u=>u.liberado===!1)?.galId,d.checkoutLiberado=!1}}),C(r),T(r),!r.checkoutLiberado){m("Fora do raio de atendimento",2);const d=N(i,l=>{const u=l.CLIENTES?.findIndex(f=>f.SEQ_PADRAO===r.SEQ_PADRAO||f.SEQ_PADRAO===l.cliAtendimento);u!==-1&&(l.CLIENTES[u]=r)});await S(d);return}}if(!await Ee(i,!1,D,!0)){m(`Não foi possível fazer o Check-out.
Verifique sua conexão com a internet e se seu GPS está ativo`);return}await ae(!0),I("/customer-service")}catch(e){B(e,!1)}finally{L()}}async function ee(){try{D();const e=i.CLIENTES.findIndex(t=>t.SEQ_PADRAO===o.SEQ_PADRAO),s=i.CLIENTES[e]?.alert?.findIndex(t=>t.liberado===!1),{latitude:c,longitude:r}=await k();if(o.CLI_LATITUDE!==null&&o.CLI_LONGITUDE!==null&&o.status!==1&&o.galId!==!1&&c&&r){let t=await Ne(o.CLI_LATITUDE,o.CLI_LONGITUDE,c,r,"K");t=t*1e3;const p=i.HORARIOS_TRABALHO.RAIO_ATENDIMENTO,A=t>1e3?`${parseFloat(M(t/1e3))}km`:`${parseFloat(M(t))}m`;if(t<=p){const d={pos:e,status:1};await te(i?.CLIENTES[e]?.alert[s]?.galId),await j(d),m("Atendimento liberado",1),L();return}else typeof e=="number"&&e!==-1&&typeof s=="number"&&s!==-1&&(i.CLIENTES[e].alert[s].DISTANCE=A,await S(i))}const n=await Ie(o,i,1);await j(n)}catch{}finally{L()}}async function te(e){try{const s=G();if(s){const c=s.empresaId,r=s.codigoUsuario,n={};n.galId=e,n.liberado=!0,n.lido=!0,await q.put(`v1/tradedashboard/alerts/${c}/${r}`,n)}}catch{}}async function j(e){if(!e)return;if(e.pos===void 0||!i.CLIENTES[e.pos]){console.error("Invalid customer position in handleStopBlock");return}const s=i.CLIENTES[e.pos].alert?.findIndex(r=>r.liberado===!1);if(s===-1||s===void 0){m("Atendimento liberado",1);const r=N(o,n=>{n.alert=[],n.galId=!1,n.checkoutLiberado=!0});C(r),T(r);return}const c=Se(new Date);if(e.status===1){const r=N(i,t=>{t.CLIENTES[e.pos].alert[s].liberado=!0,t.CLIENTES[e.pos].alert[s].lido=!0,t.CLIENTES[e.pos].alert[s].observation=`Liberado ${c}`,t.CLIENTES[e.pos].galId=!1,t.CLIENTES[e.pos].checkoutLiberado=!0}),n=N(o,t=>{t.alert=[],t.galId=!1,t.checkoutLiberado=!0});E(r),C(n),T(n),m("Atendimento liberado",1),await S(r)}else if(e.status===-1){const r=N(i,t=>{t.CLIENTES[e.pos].alert[s].liberado=-1,t.CLIENTES[e.pos].alert[s].lido=!0,t.CLIENTES[e.pos].alert[s].observation=`Não foi liberado ${c}`,t.CLIENTES[e.pos].galId=-1}),n=N(o,t=>{t.alert=[]});E(r),C(n),T(n),await S(r)}}async function ae(e=!1){const{latitude:s,longitude:c}=await k();if(!s||!c){m("Não foi possível buscar a localização atual, tente novamente"),L();return}const r=N(i,function(n){for(const t of n.CLIENTES)if(t.SEQ_PADRAO===o?.SEQ_PADRAO){if(e){for(const p of t.checkIn)if(p.status===1){p.status=0,p.stop=new Date,p.latitudeCheckOut=s,p.longitudeCheckOut=c;break}t.status=2,t.lastCheckout=new Date,n.emAtendimento=!1,n.cliAtendimento=o?.SEQ_PADRAO}else t.pesquisas=x;break}n.cliAtendimento=void 0});await S(r)}return g.useEffect(()=>{(async function(){try{y();let s=null;b&&(s=b);const c=await ie(),r=c?.CLIENTES?.findIndex(t=>t.SEQ_PADRAO===s?.SEQ_PADRAO||t.SEQ_PADRAO===c?.cliAtendimento);if(r!==-1){C(c?.CLIENTES[r]);const t=c?.CLIENTES[r].pesquisas;let p=!1,A=0,d=0;for(const l of t){if(p=!1,A=0,d=0,l.DETALHAMENTO[0]!==void 0&&l.DETALHAMENTO[0].PERGUNTAS!==void 0){const u=l.DETALHAMENTO[0].PERGUNTAS.filter(f=>f.GPP_FLG_STATUS===1);A+=u.length,d+=u.filter(f=>R(f.RESPOSTA))?.length,l.ALERTA_OBRIGATORIO=l.DETALHAMENTO[0]?.GAP_FLG_OBRIGATORIA_NAO_APLICA?!1:u.find(f=>f.GPP_FLG_ORIGATORIA===1&&!R(f.RESPOSTA))!==void 0,l.QTDE_PERGUNTAS=A,l.QTDE_PERGUNTAS_RESPONDIDAS=d,l.PERCENTUAL_CONCLUIDO=F(100*d/A,0)+"%",l.CONCLUIDO=100*d/A;continue}if(l.DETALHAMENTO[0]!==void 0&&l.DETALHAMENTO[0].AGRUPAMENTO!==void 0){for(const u of l.DETALHAMENTO[0].AGRUPAMENTO){for(const f of u.ITEMS){const O=f.PERGUNTAS.filter(h=>h.GPP_FLG_STATUS===1);A+=O.length;const U=O.filter(h=>R(h.RESPOSTA)),se=O.every(h=>h.GPP_FLG_ORIGATORIA===0&&f.GGI_FLG_ORIGATORIA_NAO_APLICA===1);d+=se?O.filter(h=>R(h.RESPOSTA)).length:U?U.length:0,p||(p=O.find(h=>h.GPP_FLG_ORIGATORIA===1&&!R(h.RESPOSTA)&&f.GGI_FLG_ORIGATORIA_NAO_APLICA===0)!==void 0)}l.QTDE_PERGUNTAS=A,l.QTDE_PERGUNTAS_RESPONDIDAS=d,l.PERCENTUAL_CONCLUIDO=F(100*d/A,0)+"%",l.CONCLUIDO=100*d/A}l.ALERTA_OBRIGATORIO=l.DETALHAMENTO[0]?.GAP_FLG_OBRIGATORIA_NAO_APLICA?!1:p}}H(t)}E(c);const n=G();n&&$(n?.flagAdministrativo)}catch{}})()},[]),K||J?a.jsx(ne,{loadingTrue:!0}):a.jsxs(a.Fragment,{children:[a.jsx(le,{title:"Pesquisas",showBackButton:!0,backPath:"/customer-service"}),a.jsxs("div",{className:"min-h-full background-pages flex flex-col pt-2 lg:pt-14",children:[a.jsxs("section",{className:"items-start justify-between p-2 flex flex-col gap-2",children:[a.jsx("h2",{className:"text-4xl font-bold text-center text-primary w-full",children:o?.CLI_NOME_FANTASIA}),z&&a.jsxs("button",{onClick:X,className:"px-4 py-2 bg-primary/90 text-white rounded-full text-lg flex items-center gap-2 active:scale-95 transition-transform drop-shadow-xl drop-shadow-primary/40",children:[a.jsx("i",{children:a.jsx(_e,{size:22})}),"Admin"]}),P&&P?.length>0&&a.jsxs("button",{onClick:()=>I("/events",{state:P}),className:"px-4 py-2 bg-primary/90 text-white rounded-full text-lg flex items-center gap-2 active:scale-95 transition-transform drop-shadow-xl drop-shadow-primary/40",children:[a.jsx("i",{children:a.jsx(ge,{size:22})}),"Ver os eventos para esse cliente"]}),Array.isArray(o?.alert)&&o?.alert?.find(e=>e.liberado===!1)&&a.jsxs("div",{className:"w-full flex flex-col items-center justify-center gap-2 bg-red-50 border border-red-200/80 rounded-lg p-3",children:[a.jsxs("span",{className:"text-center font-semibold text-red-800 text-base",children:["Check-out bloqueado - Distância:"," ",o?.alert?.find(e=>e.liberado===!1)?.DISTANCE]}),a.jsxs("button",{onClick:ee,className:"px-4 py-2 bg-primary/90 text-white rounded-full text-sm flex items-center gap-2 active:scale-95 transition-transform",children:[a.jsx("i",{children:a.jsx(Ce,{size:16})}),"Verificar liberação"]})]})]}),a.jsxs("main",{className:"flex-1 overflow-y-auto px-1 pb-24 pt-4",children:[a.jsx(xe,{stopWatch:V,interruptForced:W}),a.jsx("div",{className:"w-full space-y-4",children:x?.map(e=>{const s=e.QTDE_PERGUNTAS_RESPONDIDAS/e.QTDE_PERGUNTAS*100;return a.jsx("div",{className:ce("rounded-2xl p-px shadow-sm",e.ALERTA_OBRIGATORIO?"bg-linear-to-r from-red-100 via-orange-200 to-red-700":"bg-linear-to-r from-green-100 via-emerald-200 to-green-700"),children:a.jsx("button",{onClick:()=>Y(e),className:"relative w-full bg-white rounded-[calc(1rem-1px)] overflow-hidden",children:a.jsxs("div",{className:"py-4 px-2",children:[a.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[a.jsx("div",{className:"w-12 h-12 rounded-full bg-linear-to-br from-primary/65 to-primary flex items-center justify-center shadow-lg shrink-0",children:a.jsx(me,{size:24,className:"text-white"})}),a.jsxs("div",{className:"flex-1 text-left",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.GAP_ICONE&&a.jsx("img",{src:e.GAP_ICONE,alt:e.GAP_DESCRICAO,className:"h-6 w-6"}),a.jsx("h2",{className:"text-gray-900 font-semibold",children:e.GAP_DESCRICAO}),e.ALERTA_OBRIGATORIO?a.jsx(be,{size:18,strokeWidth:3,className:"text-red-500 shrink-0"}):a.jsx(de,{size:18,strokeWidth:3,className:"text-primary shrink-0"})]}),a.jsxs("p",{className:"text-sm text-gray-600",children:[e.QTDE_PERGUNTAS_RESPONDIDAS,"/",e.QTDE_PERGUNTAS," respondidas"]})]}),a.jsx(ue,{size:24,className:"text-gray-400"})]}),a.jsx("div",{className:"relative w-full h-2 bg-gray-200 rounded-full overflow-hidden",children:a.jsx("div",{className:"absolute top-0 left-0 h-full bg-linear-to-r from-primary/35 to-primary transition-all duration-300 rounded-full",style:{width:`${s}%`}})})]})})},e.GFP_ID)})})]}),a.jsx("footer",{className:"fixed bottom-0 left-0 right-0 bg-white/50 backdrop-blur-sm border-t border-primary/20 p-4 shrink-0",children:a.jsx("div",{className:"w-full",children:a.jsxs("button",{onClick:()=>{if(Array.isArray(o?.alert)&&o?.alert?.find(e=>e.liberado===!1)){m("Check-out bloqueado",2);return}Z()},className:"drop-shadow-xl lg:ml-20 drop-shadow-primary/40 w-full max-w-[220px] py-3 px-6 rounded-2xl bg-primary/90 text-white active:scale-[0.98] transition-transform flex items-center justify-center gap-2 font-semibold",children:[a.jsx(pe,{size:20}),a.jsx("span",{className:"text-base",children:"Check-out"})]})})})]})]})}export{Ve as default};
