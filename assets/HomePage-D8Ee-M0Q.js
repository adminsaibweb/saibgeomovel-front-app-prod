import{I as Z,L as l,K as ie,N as e,O as C,P as ge,X as _e,V as Q,S as u,R as ae,W as te,Y as Ke,Z as ye,_ as De,J as Ge,a0 as je,a1 as Le,a2 as be,a3 as re,a4 as Ce}from"./index-DyoTrttr.js";import{C as ve}from"./calendar-DReXcPtZ.js";import{D as Ae,a as Ie,b as he,c as xe,d as fe}from"./dialog-DJtUg4ZH.js";import{I as oe}from"./input-UCdoJ7gY.js";import{L as V}from"./label-CxnlyZpL.js";import{P as Oe,a as Fe,b as Te}from"./popover-CM43x2Ig.js";import{g as Y,h as we,u as Se,l as Ee,a as Re,C as ke,s as ze,e as Ue}from"./homeServices-DqQGa-FX.js";import{C as W}from"./camera-ZWwgeZuu.js";import{C as Be}from"./calendar-S-JGCjKB.js";import{f as q}from"./format-BBYAYFtJ.js";import{d as ce,w as He,g as Pe,a as $e,f as de}from"./timesAndDates-1cQtfPVw.js";import{h as qe}from"./handleApiError-kT6tIuMW.js";import{C as Je}from"./clock-lBVefJM5.js";import{T as me}from"./timer-B7p2yRZO.js";import{R as We}from"./refresh-cw-D2eBahGt.js";import{C as Ve}from"./check-check-phnDRSI5.js";import{S as Qe}from"./store-CIUoaeNQ.js";import"./startOfDay-Be0wd0F5.js";import"./addDays-CyOWDzeI.js";import"./chevron-down-DHv8nuNw.js";import"./index-Y5F-0usq.js";import"./index-EUJ98zd7.js";import"./index-F2Tpailh.js";import"./apiEndpoints-aSQtSIWE.js";import"./currency-CxFzcO-j.js";import"./useQuery-B55-6vEf.js";import"./pt-BR-mIVN-mbg.js";const Ze=[["path",{d:"M15.6 2.7a10 10 0 1 0 5.7 5.7",key:"1e0p6d"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M13.4 10.6 19 5",key:"1kr7tw"}]],Xe=Z("circle-gauge",Ze);const Ye=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],ea=Z("copy",Ye);const aa=[["circle",{cx:"12",cy:"16",r:"1",key:"1au0dj"}],["rect",{x:"3",y:"10",width:"18",height:"12",rx:"2",key:"6s8ecr"}],["path",{d:"M7 10V7a5 5 0 0 1 10 0v3",key:"1pqi11"}]],Ne=Z("lock-keyhole",aa);const ta=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],sa=Z("play",ta);const na=[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]],ia=Z("smartphone",na);function la({open:s,onOpenChange:d,currentDrivenOdometro:r,HodometroD:w}){const[h,B]=l.useState(new Date),[M,A]=l.useState({img:r?.GKM_KM_INICIAL_FOTO||null,fileExtension:""}),[f,g]=l.useState({img:r?.GKM_KM_FINAL_FOTO||null,fileExtension:""}),[a,S]=l.useState(r||{GKM_USR_AGENDA_ID:null,GKM_DATA:null,GKM_KM_INICIAL:null,GKM_KM_INICIAL_DATA:null,GKM_KM_INICIAL_FOTO:null,GKM_KM_INICIAL_LATITUDE:null,GKM_KM_INICIAL_LONGITUDE:null,GKM_KM_FINAL:null,GKM_KM_FINAL_DATA:null,GKM_KM_FINAL_FOTO:null,GKM_KM_FINAL_LATITUDE:null,GKM_KM_FINAL_LONGITUDE:null,GAA_KM_INICIAL:null,GAA_KM_FINAL:null}),{showLoading:v,hideLoading:I,isLoading:O}=ie();async function E(i,n=1920,_=.7){return new Promise((j,x)=>{const p=new FileReader;p.readAsDataURL(i),p.onload=U=>{const o=new Image;o.src=U.target?.result,o.onload=()=>{const b=document.createElement("canvas");let F=o.width,R=o.height;F>n&&(R=R*n/F,F=n),b.width=F,b.height=R,b.getContext("2d")?.drawImage(o,0,0,F,R),b.toBlob(X=>{X?j(X):x(new Error("Falha ao comprimir imagem"))},"image/jpeg",_)},o.onerror=x},p.onerror=x})}async function $(i){try{v();const n=i.target.files?.[0];if(n){const _=await E(n,1920,.7),j=n.name.substring(n.name.lastIndexOf("."),n.name.length),x=_.size<n.size?_:n;return{img:await Ke(x),fileExtension:j}}}catch{u("Não foi possível salvar a imagem")}finally{I()}}async function t(){try{const i=Q();if(i){v();const{latitude:n,longitude:_}=await Y();if(!n||!_){u("Não foi possível buscar a localização atual, tente novamente"),I();return}const j=i.empresaId,x=i.codigoUsuario,p=i.empresaCnpj;if(!Number(a.GAA_KM_INICIAL)&&Number(a.GAA_KM_INICIAL)===0&&!a.GAA_KM_FINAL&&a.GAA_KM_FINAL===0){u("Informe os dados do hodômetro");return}if(a.GAA_KM_FINAL&&a.GAA_KM_FINAL<a.GAA_KM_INICIAL){u("A quilometragem do fim do dia não pode ser menor que a do início");return}if(!a?.GKM_KM_INICIAL_FOTO&&M.img&&(a.GKM_KM_INICIAL_FOTO=await m(M.img,`Foto_inicio${M.fileExtension}`,"km inicio dia",x,p)),!a?.GKM_KM_FINAL_FOTO&&f.img&&(a.GKM_KM_FINAL_FOTO=await m(f.img,`Foto_fim${f.fileExtension}`,"km fim dia",x,p)),a?.GAA_KM_INICIAL&&!a.GKM_KM_INICIAL_FOTO){u("Adicione a foto do início do dia");return}if(a?.GAA_KM_FINAL&&!a.GKM_KM_FINAL_FOTO){u("Adicione a foto do fim do dia");return}const U={GKM_USR_AGENDA_ID:x,GKM_DATA:q(h,"yyyy-MM-dd"),GKM_KM_INICIAL:a?.GAA_KM_INICIAL,GKM_KM_INICIAL_DATA:a?.GKM_KM_INICIAL_FOTO&&!a?.GKM_KM_INICIAL_DATA?q(h,"yyyy-MM-dd hh:mm:ss"):a?.GKM_KM_INICIAL_DATA,GKM_KM_INICIAL_FOTO:a.GKM_KM_INICIAL_FOTO,GKM_KM_INICIAL_LATITUDE:a?.GKM_KM_INICIAL_FOTO&&!a?.GKM_KM_INICIAL_LATITUDE?n:a?.GKM_KM_INICIAL_LATITUDE,GKM_KM_INICIAL_LONGITUDE:a?.GKM_KM_INICIAL_FOTO&&!a?.GKM_KM_INICIAL_LONGITUDE?_:a?.GKM_KM_INICIAL_LONGITUDE,GKM_KM_FINAL:a?.GAA_KM_FINAL,GKM_KM_FINAL_DATA:a?.GKM_KM_FINAL_FOTO&&!a?.GKM_KM_FINAL_DATA?q(h,"yyyy-MM-dd hh:mm:ss"):a?.GKM_KM_FINAL_DATA,GKM_KM_FINAL_FOTO:a.GKM_KM_FINAL_FOTO,GKM_KM_FINAL_LATITUDE:a?.GKM_KM_FINAL_FOTO&&!a?.GKM_KM_FINAL_LATITUDE?n:a?.GKM_KM_FINAL_LATITUDE,GKM_KM_FINAL_LONGITUDE:a?.GKM_KM_FINAL_FOTO&&!a?.GKM_KM_FINAL_LONGITUDE?_:a?.GKM_KM_FINAL_LONGITUDE},o=await ae.post(`v2/trade/kmdriven/${j}/${x}`,U),{sucess:b,data:F}=o.data;if(b){let R=F;Array.isArray(F)&&(R=F[0]),a?.GKM_KM_FINAL_FOTO?te("hodometroActive",!1):te("hodometroActive",!0),te("currentDrivenOdometro",R),S(R),d(!1),u("Salvo com sucesso",1)}}}catch{u("Não foi possível salvar")}finally{I()}}async function m(i,n,_,j,x){try{const p={fileName:n,id:1,imageData:i,uniqueid:_},U="/v2/trade/sync/image/"+x+"/"+j,o=await ae.post(U,p,{timeout:30*1e3}),{data:b}=o.data;if(ye(b))return b.urlPath}catch{u("Não foi possível salvar a foto")}}async function N(i){try{B(i);const n=Q();if(n){v();const{latitude:_,longitude:j}=await Y();if(!_||!j){u("Não foi possível buscar a localização atual, tente novamente"),I();return}const x=n.empresaId,p=n.codigoUsuario,U=await ae.get(`v2/trade/kmdriven/${x}/${p}`,{params:{data:q(i,"dd-MM-yyyy"),usuarioAgenda:p}}),{data:o}=U.data;o&&(o&&o.length>0?(o[0].GAA_KM_INICIAL=o[0].GKM_KM_INICIAL,o[0].GAA_KM_FINAL=o[0].GKM_KM_FINAL,A({img:o[0].GKM_KM_INICIAL_FOTO,fileExtension:""}),g({img:o[0].GKM_KM_FINAL_FOTO,fileExtension:""}),S(o[0]),K("km_initial",o[0].GKM_KM_INICIAL),K("km_final",o[0].GKM_KM_FINAL)):(S({GKM_USR_AGENDA_ID:null,GKM_DATA:null,GKM_KM_INICIAL:null,GKM_KM_INICIAL_DATA:null,GKM_KM_INICIAL_FOTO:null,GKM_KM_INICIAL_LATITUDE:null,GKM_KM_INICIAL_LONGITUDE:null,GKM_KM_FINAL:null,GKM_KM_FINAL_DATA:null,GKM_KM_FINAL_FOTO:null,GKM_KM_FINAL_LATITUDE:null,GKM_KM_FINAL_LONGITUDE:null,GAA_KM_INICIAL:null,GAA_KM_FINAL:null}),K("km_initial",""),K("km_final",""),A({img:null,fileExtension:""}),g({img:null,fileExtension:""})))}}catch{u("Não foi possível buscar os dados desse dia")}finally{I()}}function K(i,n){const _=document.getElementById(i);_&&_.type==="number"?_.value=n:console.error("O elemento não foi encontrado ou não é um input do tipo number")}const y=l.useRef(!1);l.useEffect(()=>{y.current||(async function(){y.current=!0,N(new Date)})()},[]);const L=async i=>{const n=await $(i);n&&A({img:n.img,fileExtension:n.fileExtension})},D=async i=>{const n=await $(i);n&&g({img:n.img,fileExtension:n.fileExtension})};return e.jsx(Ae,{open:s,onOpenChange:d,children:e.jsxs(Ie,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:[e.jsx(he,{className:"bg-linear-to-r from-primary to-primary/80 text-white p-6 -m-6 mb-6 rounded-t-lg",children:e.jsxs(xe,{className:"flex items-center gap-3 text-xl",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/20 flex items-center justify-center",children:e.jsx(W,{className:"w-5 h-5"})}),"Dados do Hodômetro"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"Data"}),e.jsxs(Oe,{children:[e.jsx(Fe,{asChild:!0,children:e.jsxs(C,{disabled:!r,variant:"outline",className:ge("w-full justify-start text-left font-normal h-12",!h&&"text-muted-foreground"),children:[e.jsx(Be,{className:"mr-2 h-4 w-4"}),h?q(h,"dd/MM/yyyy"):e.jsx("span",{children:"Selecione uma data"})]})}),e.jsx(Te,{className:"w-auto p-0",children:e.jsx(ve,{mode:"single",selected:h,onSelect:i=>i&&N(i),initialFocus:!0})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"km_initial",className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"KM inicial do dia"}),e.jsx(oe,{id:"km_initial",type:"number",placeholder:"Digite a quilometragem inicial",disabled:a.GKM_ID===r?.GKM_ID&&r?.GKM_KM_INICIAL,value:a.GAA_KM_INICIAL||"",onChange:i=>S({...a,GAA_KM_INICIAL:i.target.value}),className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"photo-inicial",className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"Foto do início do dia"}),e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-8 hover:border-primary transition-colors",children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4",children:[M.img?e.jsx("img",{src:M.img,alt:"Foto inicial",className:"max-w-full h-auto rounded-lg"}):e.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center",children:e.jsx(W,{className:"w-10 h-10 text-primary"})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-zinc-600 mb-1",children:"Clique para adicionar uma foto"})}),e.jsx("input",{id:"photo-inicial",type:"file",accept:"image/*",capture:w?void 0:"environment",disabled:a.GKM_ID===r?.GKM_ID&&r?.GKM_KM_INICIAL_FOTO,onChange:L,className:"hidden"}),e.jsxs(C,{type:"button",variant:"outline",onClick:()=>document.getElementById("photo-inicial")?.click(),className:"gap-2",disabled:O||a.GKM_ID===r?.GKM_ID&&r?.GKM_KM_INICIAL_FOTO,children:[e.jsx(W,{size:16}),"Selecionar foto"]})]})})]}),a?.GKM_KM_INICIAL!==null&&a?.GKM_KM_INICIAL_FOTO&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"km_final",className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"KM final do dia"}),e.jsx(oe,{id:"km_final",type:"number",placeholder:"Digite a quilometragem final",disabled:a.GKM_ID===r?.GKM_ID&&r?.GKM_KM_FINAL,value:a.GAA_KM_FINAL||"",onChange:i=>S({...a,GAA_KM_FINAL:i.target.value}),className:"h-12"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"photo-final",className:"text-base font-semibold text-gray-700 border-l-4 border-primary pl-3",children:"Foto do fim do dia"}),e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-8 hover:border-primary transition-colors",children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4",children:[f.img?e.jsx("img",{src:f.img,alt:"Foto final",className:"max-w-full h-auto rounded-lg"}):e.jsx("div",{className:"w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center",children:e.jsx(W,{className:"w-10 h-10 text-primary"})}),e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-zinc-600 mb-1",children:"Clique para adicionar uma foto"})}),e.jsx("input",{id:"photo-final",type:"file",accept:"image/*",capture:w?void 0:"environment",onChange:D,disabled:a.GKM_ID===r?.GKM_ID&&r?.GKM_KM_FINAL_FOTO,className:"hidden"}),e.jsxs(C,{type:"button",variant:"outline",onClick:()=>document.getElementById("photo-final")?.click(),className:"gap-2",disabled:O||a.GKM_ID===r?.GKM_ID&&r?.GKM_KM_FINAL_FOTO,children:[e.jsx(W,{size:16}),"Selecionar foto"]})]})})]})]})]}),e.jsxs(fe,{className:"gap-2",children:[e.jsxs(C,{type:"button",variant:"outline",onClick:()=>d(!1),className:"gap-2",disabled:O,children:[e.jsx(_e,{size:16}),"Fechar"]}),e.jsxs(C,{type:"button",onClick:t,className:"gap-2 min-w-48 bg-primary",disabled:O||a.GKM_ID===r?.GKM_ID&&r?.GKM_KM_FINAL_FOTO,children:[e.jsx(W,{size:16}),O?"Carregando...":"Salvar"]})]})]})})}function ra({open:s,onOpenChange:d}){const[r,w]=l.useState(null),{showLoading:h,hideLoading:B}=ie();async function M(){const A=Q();if(!A){u("Sessão expirada");return}const f=A.email;h("Gerando código");const g=await we(f);B(),g&&w(g)}return e.jsx(Ae,{open:s,onOpenChange:d,children:e.jsxs(Ie,{className:"sm:max-w-[500px] max-h-[90vh] overflow-y-auto",children:[e.jsx(he,{className:"bg-linear-to-r from-primary to-primary/80 text-white p-6 -m-6 mb-6 rounded-t-lg",children:e.jsxs(xe,{className:"flex items-center gap-3 text-xl",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-white/20 flex items-center justify-center",children:e.jsx(Ne,{className:"w-5 h-5"})}),"Código para limpeza de dados locais"]})}),e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4",children:[e.jsxs("p",{className:"font-medium text-center text-zinc-600",children:["Segue abaixo o codigo para liberação de limpeza de dados locais, este código pode ser utilizado apenas ",e.jsx("strong",{children:"UMA"})," vez"]}),r&&e.jsxs("span",{className:"bg-primary/20 py-2 px-6 rounded-md border-dotted border-primary text-primary text-2xl font-bold flex items-center justify-center",children:[r,e.jsx("button",{type:"button",onClick:()=>{navigator.clipboard.writeText(r),u("Código copiado!",1)},className:"ml-2 p-1 rounded-md hover:bg-primary/30 transition-colors",children:e.jsx(ea,{size:24})})]}),e.jsx(C,{className:"min-w-48",onClick:M,children:"Gerar código"})]}),e.jsx(fe,{className:"gap-2 mt-6",children:e.jsxs(C,{type:"button",variant:"outline",onClick:()=>d(!1),className:"gap-2",children:[e.jsx(_e,{size:16}),"Fechar"]})})]})})}function se({stopWatch:s,variant:d}){return d==="day-finalized"?e.jsx("div",{className:"w-full mb-4 overflow-hidden rounded-xl border border-red-900/30 bg-red-950 shadow-lg",children:e.jsxs("div",{className:"flex items-start gap-3 p-4",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-lg bg-red-900 text-red-300",children:e.jsx("i",{children:e.jsx(Je,{size:20})})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"text-sm font-semibold text-red-50",children:"Horário de Atendimento Encerrado"}),e.jsx("p",{className:"text-xs text-red-100",children:"O expediente de hoje foi finalizado"})]})]})}):d==="waiting-end"?e.jsxs("div",{className:"w-full mb-4 overflow-hidden rounded-xl border border-orange-900/30 bg-orange-950 shadow-lg",children:[e.jsxs("div",{className:"flex items-start gap-3 p-4",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-lg bg-orange-900 text-orange-300",children:e.jsx("i",{children:e.jsx(me,{size:20})})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"text-sm font-semibold text-orange-50",children:"Encerrando em Breve"}),e.jsx("p",{className:"text-xs text-orange-100",children:"Finalize seus atendimentos pendentes"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-black/20 px-4 py-3 gap-1",children:[e.jsx("span",{className:"text-base font-medium text-orange-100",children:"Encerramento em"}),e.jsxs("span",{className:"font-mono text-xl font-bold tracking-wider text-orange-100",children:[s.hours.toString().padStart(2,"0"),":",s.minutes.toString().padStart(2,"0"),":",s.seconds.toString().padStart(2,"0")]})]})]}):e.jsxs("div",{className:"w-full mb-4 overflow-hidden rounded-xl border border-purple-900/30 bg-purple-950 shadow-lg",children:[e.jsxs("div",{className:"flex items-start gap-3 p-4",children:[e.jsx("div",{className:"flex h-10 w-10 items-center justify-center rounded-lg bg-purple-900 text-purple-300",children:e.jsx("i",{children:e.jsx(me,{size:20})})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("h3",{className:"text-sm font-semibold text-purple-50",children:"Aguardando Horário de Início"}),e.jsx("p",{className:"text-xs text-purple-100",children:"O atendimento será liberado em breve"})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-black/20 px-4 py-3 gap-1",children:[e.jsx("span",{className:"text-base font-medium text-purple-100",children:"Início em"}),e.jsxs("span",{className:"font-mono text-xl font-bold tracking-wider text-purple-100",children:[s.hours.toString().padStart(2,"0"),":",s.minutes.toString().padStart(2,"0"),":",s.seconds.toString().padStart(2,"0")]})]})]})}const oa=30*1e3;function ne(s){const d=Math.abs(s);return{totalTimeInSeconds:d,hours:Math.floor(d/3600)%24,minutes:Math.floor(d/60)%60,seconds:d%60}}function ue(s){if(!s)return null;const d=new Date,[r,w,h]=s.split(":",3).map(Number);return d.setHours(r,w,h||0,0),d}function ca(s){return He(new Date)!=="Sábado"?s:{...s,INICIO_JORNADA:s.INICIO_JORNADA_SA??s.INICIO_JORNADA,FIM_JORNADA:s.FIM_JORNADA_SA??s.FIM_JORNADA,INICIO_PARADA1:s.INICIO_PARADA1_SA??s.INICIO_PARADA1,FIM_PARADA1:s.FIM_PARADA1_SA??s.FIM_PARADA1,FORCAR_PARADA1:s.FORCAR_PARADA1_SA??s.FORCAR_PARADA1}}function da(){const[s,d]=l.useState(ne(0)),[r,w]=l.useState(!1),[h,B]=l.useState(!1),[M,A]=l.useState(!1),f=l.useRef(null),g=l.useRef(null),a=l.useRef(null),S=l.useRef(null),v=l.useRef(!1),I=l.useCallback(()=>{f.current&&(clearInterval(f.current),f.current=null),g.current&&(clearInterval(g.current),g.current=null)},[]),O=l.useCallback(m=>{d(ne(m))},[]),E=l.useCallback(m=>{const N=new Date,K=a.current,y=S.current;if(!K||!y){A(!0);return}const L=ce(N,K),D=ce(N,y);if(D>0){A(!1),w(!0),I();return}if(m)A(!0);else{if(L<0){A(!1),O(L);return}A(!0)}D>=-1800&&D!==0?(B(!0),O(D)):(B(!1),(m||L>=0)&&I())},[O,I]),$=l.useCallback(m=>{I(),f.current=setInterval(()=>{d(N=>N.totalTimeInSeconds>0?ne(N.totalTimeInSeconds-1):(E(m),N))},1e3),g.current=setInterval(()=>{E(m)},oa)},[I,E]),t=l.useCallback(m=>{if(!m?.HORARIOS_TRABALHO)return m;const N=m.HORARIOS_TRABALHO;if(Object.keys(N).length===0)return A(!0),{...m,HORARIOS_TRABALHO:{...N,Released:!0}};const K=ca(N),y=ue(K.INICIO_JORNADA),L=ue(K.FIM_JORNADA);if(a.current=y,S.current=L,!y||!L)return A(!0),{...m,HORARIOS_TRABALHO:{...K,Released:!0}};const D=!m.endAttendances&&!!m.startAttendances;return E(D),v.current||($(D),v.current=!0),{...m,HORARIOS_TRABALHO:{...K,Released:M}}},[E,$,M]);return l.useEffect(()=>()=>{I(),v.current=!1},[I]),{stopWatch:s,isDayFinalized:r,isCheckMinutesForEnd:h,isReleased:M,initializeSchedule:t}}function Ra(){const[s,d]=l.useState(null),[r,w]=l.useState(!1),[h,B]=l.useState(null),[M,A]=l.useState(!1),[f,g]=l.useState(!1),[a,S]=l.useState({GKM_USR_AGENDA_ID:null,GKM_DATA:null,GKM_KM_INICIAL:null,GKM_KM_INICIAL_DATA:null,GKM_KM_INICIAL_FOTO:null,GKM_KM_INICIAL_LATITUDE:null,GKM_KM_INICIAL_LONGITUDE:null,GKM_KM_FINAL:null,GKM_KM_FINAL_DATA:null,GKM_KM_FINAL_FOTO:null,GKM_KM_FINAL_LATITUDE:null,GKM_KM_FINAL_LONGITUDE:null}),{stopWatch:v,isDayFinalized:I,isCheckMinutesForEnd:O,isReleased:E,initializeSchedule:$}=da(),{data:t,isLoading:m,isFetching:N}=Se(),K=De(),y=Ge(),{showLoading:L,hideLoading:D}=ie();async function i(){try{if(!await be({title:"Iniciar atendimento",component:e.jsx("span",{className:"font-bold text-lg text-center",children:"Deseja iniciar o atendimento?"}),confirm:"Iniciar"}))return;L("Iniciando atendimento");const k=s?.gmovelHodometro,H=await re("currentDrivenOdometro");if(k&&t?.scheduleData!==void 0&&t?.scheduleData.status===void 0&&!t?.scheduleData?.sucessStarted&&(!H||!H.GKM_KM_INICIAL_FOTO&&!H.GKM_KM_INICIAL)){u("Para iniciar o dia, é necessário informar o KM inicial, e a foto");return}const{latitude:z,longitude:G}=await Y();if(!z||!G){u("Não foi possível buscar a localização atual, tente novamente"),D();return}if(t?.scheduleData.status===void 0){const J=de(new Date),T=await ze(t?.scheduleData,t?.scheduleData?.GAA_ID,z,G,J);if(T===void 0){u(`Não é possível continuar, o dia não foi iniciado.
Verifique sua conexão com a internet e se seu GPS está ativo`);return}if(T&&T.sucessStarted){T.status=2;const P={};P.dataHoraInicio=J,P.latitude=z,P.longitude=G,T.startAttendances=P,await Ce(T),y("/customer-service")}else{u("Não foi possível iniciar o atendimento, tente novamente");return}}}catch(c){qe(c,!1)}finally{D()}}function n(c){K.setQueryData(["getScheduleHome"],()=>c)}async function _(){const{latitude:c,longitude:k}=await Y();if(!c||!k){u("Não foi possível buscar a localização atual, tente novamente"),D();return}const z=Q().gmovelHodometro,G=await re("currentDrivenOdometro"),J=q(new Date,"dd/MM/yyyy"),T=G?.GKM_KM_INICIAL_DATA?q(new Date(G?.GKM_KM_INICIAL_DATA),"dd/MM/yyyy"):null;if(z&&!G&&!G?.GKM_KM_FINAL&&!G?.GKM_KM_FINAL_FOTO&&T&&J!==T){u("Para finalizar o dia, é necessário informar o KM final, e a foto");return}L("Finalizando o dia");const P=de(new Date),ee=await Ue(t?.scheduleData,t?.scheduleData?.GAA_ID,c,k,P,L);D(),ee&&y("/expired")}const j=l.useRef(!1);l.useEffect(()=>((async function(){if(j.current)return;const k=Q();if(d(k),t){const H=await Ee();B(H),j.current=!0;const z=$(t.scheduleData);if(z!==t.scheduleData&&(t.scheduleData=z,n(t)),k.gmovelHodometro||k.gmovelHodometroD){const G=await Re(t?.scheduleData);G&&S(G)}}})(),()=>{j.current=!1}),[t]);const x=t?.allScheduleData&&t?.allScheduleData.length===0||!t,p=t?.allScheduleData&&t.allScheduleData.length>0,U=h!==void 0&&t?.scheduleData&&t?.scheduleData?.GAA_DTA_AGENDA===h?.GAA_DTA_AGENDA,o=t&&t?.scheduleData&&t?.scheduleData?.GAA_DTA_AGENDA===Pe()&&t?.scheduleData?.CLIENTES[0]?.SEQ_PADRAO!==-1,b=t?.scheduleData&&Object.keys(t?.scheduleData?.HORARIOS_TRABALHO).length!==0,F=b&&!t?.scheduleData?.startAttendances?!E||I:!1,R=b&&!E&&!I,le=t?.scheduleData?.CLIENTES&&t.scheduleData.CLIENTES.length>0,X=s?.gmovelHodometro||s?.gmovelHodometroD,pe=[...t?.allScheduleData||[]].sort((c,k)=>{const[H,z,G]=c.GAA_DTA_AGENDA.split("/").map(Number),[J,T,P]=k.GAA_DTA_AGENDA.split("/").map(Number),ee=new Date(G,z-1,H).getTime(),Me=new Date(P,T-1,J).getTime();return ee-Me});return m||N?e.jsx(je,{loadingTrue:!0}):e.jsxs("div",{className:"min-h-full background-pages",children:[e.jsxs("main",{className:"max-w-4xl mx-auto px-2 pb-4 pt-4 lg:pt-18",children:[e.jsxs("div",{className:"flex items-center gap-3 justify-start w-1/3",children:[s?.isAdmin&&e.jsx(C,{onClick:()=>A(!0),variant:"default",className:"flex-1 gap-2 size-10 rounded-full",children:e.jsx(Ne,{size:20,className:"text-white"})}),X&&e.jsx(C,{onClick:()=>g(!0),variant:"default",className:"flex-1 gap-2 size-10 rounded-full",disabled:!t||!t?.scheduleData,children:e.jsx(Xe,{size:20,className:"text-white"})}),e.jsx(C,{onClick:()=>y("/service-admin"),variant:"default",className:"flex-1 gap-2 size-10 rounded-full",children:e.jsx(ia,{size:20,className:"text-white"})})]}),e.jsx("div",{className:"flex items-center justify-center my-3 text-center",children:e.jsx("h1",{className:"text-3xl font-bold text-primary",children:"Agenda"})}),x&&e.jsxs("div",{className:"flex flex-col gap-2 mt-6",children:[e.jsxs(C,{onClick:()=>y(0),children:[e.jsx("i",{children:e.jsx(We,{size:20,className:"text-white"})}),"Atualizar"]}),e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border border-[#d5b5e3] p-6 text-center",children:e.jsx("h2",{className:"text-xl font-bold text-primary",children:"Sem atividades agendadas"})})]}),p&&e.jsx("div",{className:"bg-white/50 backdrop-blur-sm rounded-2xl shadow-xs mb-4 flex gap-3 overflow-x-auto p-2 pb-3 snap-x snap-mandatory scroll-smooth",children:pe.map(c=>e.jsx("button",{onClick:()=>{t.scheduleData=c,n(t),w(!r)},className:`flex-1 py-4 px-4 rounded-xl transition-all border min-w-[130px] snap-center ${t?.scheduleData?.GAA_ID===c.GAA_ID?"bg-primary text-white shadow-lg scale-[1.02] border-primary":"bg-white text-primary border-zinc-200 hover:border-primary/30 hover:bg-primary/5 shadow-sm"}`,children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:`text-xs font-medium uppercase tracking-wider mb-1 ${t?.scheduleData?.GAA_ID===c.GAA_ID?"text-white/80":"text-zinc-500"}`,children:$e(c.GAA_DTA_AGENDA)}),e.jsxs("span",{className:`text-lg font-bold ${t?.scheduleData?.GAA_ID===c.GAA_ID?"text-white":"text-zinc-900"}`,children:[c.GAA_DTA_AGENDA.split("/")[0],"/",c.GAA_DTA_AGENDA.split("/")[1]]})]})},c.GAA_DTA_AGENDA))}),U&&e.jsxs(C,{onClick:_,className:" w-full py-6 my-3",children:[e.jsx(Ve,{size:22}),"Finalizar dia"]}),o&&e.jsx("button",{disabled:F,onClick:async()=>{!t.scheduleData.status&&!t.scheduleData.sucessStarted?await i():y("/customer-service")},className:Le("w-full bg-white font-medium text-primary py-4 rounded-2xl my-3 drop-shadow-sm drop-shadow-primary transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 flex items-center justify-center gap-2",t.scheduleData.status&&t.scheduleData.sucessStarted&&"bg-linear-to-br from-primary/75 via-primary to-primary/75 text-white"),children:!t.scheduleData.status&&!t.scheduleData.sucessStarted?e.jsxs(e.Fragment,{children:[e.jsx(ke,{size:20}),e.jsx("span",{className:"text-lg",children:"Iniciar atendimento"})]}):e.jsxs(e.Fragment,{children:[e.jsx(sa,{size:20}),e.jsx("span",{className:"text-lg",children:"Continuar atendimento"})]})}),R&&e.jsx(se,{stopWatch:v,variant:"waiting-start"}),I&&e.jsx(se,{stopWatch:v,variant:"day-finalized"}),O&&e.jsx(se,{stopWatch:v,variant:"waiting-end"}),le&&e.jsx("div",{className:"space-y-4",children:t.scheduleData.CLIENTES.map(c=>e.jsx("div",{className:"bg-white rounded-2xl shadow-sm border border-[#d5b5e3] hover:shadow-lg transition-all hover:border-[#bf8fd6] cursor-pointer group overflow-hidden",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"shrink-0 w-12 h-12 rounded-xl bg-linear-to-br from-primary to-primary/75 flex items-center justify-center",children:e.jsx(Qe,{size:24,className:"text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"inline-block px-2 py-0.5 bg-primary text-white text-xs font-medium rounded-full",children:c.CLI_CODIGO}),e.jsx("h3",{className:"text-gray-900 font-bold",children:c.CLI_NOME_FANTASIA})]}),e.jsxs("p",{className:"text-sm text-gray-500 mb-2",children:["(",c.CLI_RAZAO_SOCIAL,")"]}),e.jsx("p",{className:"text-sm text-gray-600",children:c.CLI_ENDERECO})]})]})})},c.CLI_CODIGO))})]}),f&&e.jsx(la,{open:f,onOpenChange:g,currentDrivenOdometro:a,HodometroD:s?.gmovelHodometroD||!1}),M&&e.jsx(ra,{open:M,onOpenChange:()=>A(!1)})]})}export{Ra as default};
